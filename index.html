<!DOCTYPE html> 
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRS Labs - Logline Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
  (function() {
    emailjs.init({
      publicKey: "7cimGrBdlHCn4gSDy",
    });
  })();
</script>
    <script src="https://js.stripe.com/v3/"></script>
    <script type="module" src="supabase-client.js"></script>
  
    <style>
        body {
            font-family: 'Montserrat', Verdana, sans-serif;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #d9042b;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .history-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f9fafb;
        }
        .password-strength {
            height: 4px;
            border-radius: 2px;
            margin-top: 4px;
        }
        .password-weak { background-color: #ef4444; }
        .password-medium { background-color: #f59e0b; }
        .password-strong { background-color: #10b981; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Authentication Section -->
    <div id="authSection" class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="mx-auto h-12 w-auto flex justify-center">
                    <img src="logo.png" alt="BRS Labs" style="height: auto; width: auto; max-height: 48px; max-width: 200px;">
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Logline Evaluator
                </h2>
                <p id="authSubtitle" class="mt-2 text-center text-sm text-gray-600">
                    Sign in to your account
                </p>
            </div>

            <div class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <input type="email" id="authEmail" placeholder="Email address" required
                               class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div class="relative">
                        <input type="password" id="authPassword" placeholder="Password" required
                               class="relative block w-full px-3 py-2 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <span id="eyeIcon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    
                    <div id="registerFields" class="hidden space-y-4">
                        <div>
                            <input type="password" id="confirmPassword" placeholder="Confirm password" required
                                   class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <div id="passwordStrength" class="password-strength hidden"></div>
                            <div id="passwordRequirements" class="text-xs text-gray-500 mt-1 hidden">
                                Password must have: 8+ characters, uppercase, lowercase, number, special character
                            </div>
                        </div>
                        <div>
                            <input type="text" id="studentCode" placeholder="Student code (optional)"
                                   class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <p class="text-xs text-gray-500 mt-1">Have a student code? Enter it for 3 months free access!</p>
                        </div>
                    </div>
                </div>

                <div>
                    <button id="authSubmit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2"
                            style="background-color: #d9042b;">
                        <span id="authButtonText">Sign In</span>
                        <span id="authSpinner" class="hidden spinner ml-2"></span>
                    </button>
                </div>

                <div class="text-center space-y-2">
                    <button id="authToggle" class="text-red-600 hover:text-red-500 text-sm">
                        Don't have an account? Sign up
                    </button>
                    <div>
                        <button id="forgotPasswordBtn" class="text-gray-600 hover:text-gray-500 text-sm">
                            Forgot your password?
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="resetModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Reset Password</h3>
                <input type="email" id="resetEmail" placeholder="Enter your email address"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                <div class="mt-4 flex space-x-2">
                    <button id="sendResetBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                            style="background-color: #d9042b;">
                        Send Reset Link
                    </button>
                    <button id="cancelResetBtn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Credit Confirmation Modal -->
    <div id="creditConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 text-center mb-2">Confirm Evaluation</h3>
                <p class="text-sm text-gray-600 text-center mb-6">
                    Getting an evaluation will use <strong>1 credit</strong> from your account. 
                    <br><br>
                    You currently have <span id="modalCreditsRemaining" class="font-semibold text-blue-600"></span> credits remaining.
                    <br><br>
                    Are you ready to proceed?
                </p>
                <div class="flex space-x-3">
                    <button id="cancelEvaluationBtn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button id="proceedEvaluationBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
                            style="background-color: #d9042b;">
                        Proceed
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App Section -->
    <div id="appSection" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="logo.png" alt="BRS Labs" style="height: auto; width: auto; max-height: 32px; max-width: 150px;">
                    <h1 class="text-xl font-bold text-black">Logline Evaluator</h1>
                </div>

                <div class="flex items-center space-x-6">
                    <div id="userStatus" class="text-sm font-medium"></div>
                    <button id="loglineBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">Logline</button>
                    <button id="historyBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">History</button>
                    <button id="settingsBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">Settings</button>
                    <button id="logoutBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <!-- Logline Form -->
            <div id="loglineSection" class="max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="mb-8">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-3xl font-bold text-black mb-4">Get Logline Feedback</h2>
                                <p class="text-gray-600 text-lg">
                                    Submit information in each of the fields. The more information you include, the better your results. You will get feedback on your logline, five improved alternatives, and some possible title suggestions.
                                </p>
                            </div>
                            <button id="startFreshBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors ml-4 whitespace-nowrap">
                                Start Fresh
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="genre" class="block text-sm font-semibold text-black mb-2">Genre</label>
                                <input type="text" id="genre" placeholder="e.g., Psychological Thriller, Romantic Comedy" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="tone" class="block text-sm font-semibold text-black mb-2">Tone</label>
                                <input type="text" id="tone" placeholder="e.g., gritty, comedic, uplifting, psychological" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                            </div>
                        </div>

                        <div>
                            <label for="mainCharacter" class="block text-sm font-semibold text-black mb-2">Protagonist (broad strokes)</label>
                            <textarea id="mainCharacter" placeholder="Who they are and what makes them unique or compelling" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="antagonist" class="block text-sm font-semibold text-black mb-2">Antagonist / Antagonistic Force (broad strokes)</label>
                            <textarea id="antagonist" placeholder="The person, group, or environmental factor along with what they want" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="incitingIncident" class="block text-sm font-semibold text-black mb-2">Setup or Inciting Incident Summary</label>
                            <textarea id="incitingIncident" placeholder="What kicks off the story" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="storyDetails" class="block text-sm font-semibold text-black mb-2">1-2 Interesting Details About the Story</label>
                            <textarea id="storyDetails" placeholder="Any elements unique to the world of the story" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="logline" class="block text-sm font-semibold text-black mb-2">Your Logline</label>
                            <textarea id="logline" placeholder="Enter your current logline here" rows="4"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <button id="evaluateBtn" type="button" class="w-full font-semibold py-4 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2"
                                style="background-color: #d9042b; color: white;">
                            <span id="evaluateText">Get My Evaluation</span>
                            <span id="evaluateSpinner" class="hidden spinner"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-black">Your Logline Evaluation</h2>
                        <div class="flex space-x-2">
                            <button id="downloadPdfBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                Download PDF
                            </button>
                            <button id="resetBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg transition-colors">
                                Evaluate Another Logline
                            </button>
                        </div>
                    </div>

                    <div class="prose prose-lg max-w-none">
                        <div class="bg-gray-50 p-6 rounded-lg mb-6">
                            <h3 class="text-lg font-semibold text-black mb-2">Your Original Logline:</h3>
                            <p id="originalLogline" class="text-gray-800 italic"></p>
                        </div>

                        <div id="evaluationResult" class="whitespace-pre-wrap text-gray-800 leading-relaxed"></div>
                        
                        <hr class="my-8 border-gray-300">
                        
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <p class="text-gray-700 text-base leading-relaxed">
                                The Logline Evaluator is meant to help you hone and craft your logline. For better results, consider choosing one of the suggestions or a combination of the suggestions, and running that new logline through the evaluator.
                            </p>
                        </div>
                        
                        <hr class="my-6 border-gray-300">
                        
                        <div class="text-center">
                            <p class="text-gray-700">
                                If you want to learn how to write Hollywood-quality screenplays, <a href="https://sales.bigredstripe.com/crucible/?video=LoglineEvaluatorLink" target="_blank" rel="noopener noreferrer" class="text-red-600 hover:text-red-800 underline">click here</a>.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="historySection" class="hidden max-w-6xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-black">Your Evaluation History</h2>
                        <button id="showAllHistoryBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg transition-colors">
                            Show All
                        </button>
                    </div>

                    <div id="historyList" class="space-y-4">
                        <!-- History items will be inserted here -->
                    </div>

                    <div id="historyPagination" class="flex justify-center space-x-2 mt-6">
                        <!-- Pagination buttons will be inserted here -->
                    </div>

                    <div id="noHistory" class="hidden text-center py-12">
                        <p class="text-gray-500 text-lg">No evaluations yet. <a href="#" onclick="showSection('logline')" class="text-red-600 hover:text-red-800 underline">Create your first evaluation!</a></p>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="hidden max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-black mb-8">Account Settings</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Account Information -->
                        <div class="space-y-6">
                            <h3 class="text-xl font-semibold text-black">Account Information</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                <div class="flex space-x-2">
                                    <input type="email" id="newEmail" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    <button id="updateEmailBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700" style="background-color: #d9042b;">
                                        Update
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <h4 class="text-lg font-medium text-gray-900">Change Password</h4>
                                <div>
                                    <input type="password" id="currentPassword" placeholder="Current password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                </div>
                                <div>
                                    <input type="password" id="newPassword" placeholder="New password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    <div id="newPasswordStrength" class="password-strength hidden"></div>
                                </div>
                                <div>
                                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                </div>
                                <button id="updatePasswordBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700" style="background-color: #d9042b;">
                                    Update Password
                                </button>
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="space-y-6">
                            <h3 class="text-xl font-semibold text-black">Payment Information</h3>
                            
                            <div id="creditUserPayment" class="hidden">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <p class="text-sm text-gray-600 mb-2">Current Credits: <span id="currentCredits" class="font-semibold"></span></p>
                                </div>
                                
                                <button id="managePaymentBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 mb-4">
                                    Manage Payment Methods
                                </button>
                                
                                <button id="buyMoreCreditsBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    Buy More Credits
                                </button>
                            </div>

                            <div id="studentUserPayment" class="hidden">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-sm text-green-800">
                                        Student Access: <span id="studentDaysLeft" class="font-semibold"></span> days remaining
                                    </p>
                                </div>
                            </div>

                            <div id="adminUserPayment" class="hidden">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-sm text-purple-800 font-semibold">Administrator - Unlimited Access</p>
                                </div>
                            </div>
                            <div id="subscriberUserPayment" class="hidden">
    <div class="bg-gray-50 p-4 rounded-lg mb-4">
        <p class="text-sm text-gray-600 mb-2">Status: <span id="subscriptionStatus"></span></p>
    </div>
    <button onclick="showSection('purchase')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        Manage Subscription
    </button>
</div>
                        </div>
                    </div>

                    <!-- Admin Section -->
                    <div id="adminSettings" class="hidden mt-12 pt-8 border-t border-gray-200">
                        <h3 class="text-xl font-semibold text-black mb-6">Admin Functions</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                          <!-- User Management -->
<div class="space-y-4">
    <h4 class="text-lg font-medium text-gray-900">User Management</h4>
    <div class="space-y-3">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Search User by Email</label>
            <input type="email" id="userSearchEmail" placeholder="Enter user email address"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
        </div>
        <button id="searchUserBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Search User
        </button>
        
        <div id="userManagementResult" class="hidden mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div id="userDetails" class="mb-4"></div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Set Credits (Replaces Current)</label>
                    <input type="number" id="setCredits" min="0" max="9999" placeholder="Enter credits"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <button id="updateCreditsBtn" class="w-full mt-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Set Credits
                    </button>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Set Time (Replaces Current)</label>
                    <input type="number" id="setMonths" min="0" max="24" placeholder="Months from now"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <button id="setTimeBtn" class="w-full mt-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Set Time
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
                            
                            <!-- Student Codes -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-medium text-gray-900">Generate Student Codes</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                        <input type="number" id="codeQuantity" min="1" value="1"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Months</label>
                                        <input type="number" id="codeMonths" min="1" value="3"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                        <p class="text-xs text-gray-500 mt-1">For time-based codes</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Code Type</label>
                                        <div class="px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-sm text-gray-700">
                                            Time-based only (months of unlimited access)
                                        </div>
                                    </div>
                                </div>
                                <button id="generateCodesBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                                        style="background-color: #d9042b;">
                                    Generate Codes
                                </button>
                                <button id="downloadCodesBtn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg">
                                    Download Codes (<span id="codesCount">0</span>)
                                </button>
                            </div>

                            <!-- Analytics -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-medium text-gray-900">Analytics</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-red-600" id="totalUsers">0</div>
                                        <div class="text-sm text-gray-600">Total Users</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-red-600" id="totalEvaluations">0</div>
                                        <div class="text-sm text-gray-600">Total Evaluations</div>
                                    </div>
                                </div>
                                <button id="downloadAllSubmissionsBtn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg">
                                    Download All Submissions (<span id="submissionsCount">0</span>)
                                </button>
                                <button id="viewUsersBtn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg mb-2">
                                    View All Users (<span id="userCount">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

       <!-- Purchase Section -->
            <div id="purchaseSection" class="hidden max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-black mb-6">Choose Your Subscription</h2>
                    <p class="text-gray-600 mb-8">Get unlimited logline evaluations with a subscription plan.</p>

                    <!-- Phase Discount Banner -->
                    <div id="subscriptionDiscountBanner" class="hidden border rounded-lg p-4 mb-10 text-center">
                        <h3 class="font-bold text-lg" id="discountTitle"></h3>
                        <p class="text-base font-medium" id="discountMessage"></p>
                    </div>

                    <!-- Three Subscription Tiers -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Monthly Tier -->
                        <div class="border border-gray-300 rounded-lg p-6 text-center">
                            <h3 class="text-xl font-bold mb-2">Monthly</h3>
                            <div class="text-3xl font-bold text-gray-700 mb-2" id="monthlyPrice">$36</div>
                            <div class="text-sm text-gray-600 mb-2" id="monthlyDiscountText">per month</div>
                            <div class="text-gray-600 mb-4">Unlimited Evaluations</div>
                            <button onclick="subscribeToTier('monthly')" class="w-full py-2 px-4 bg-gray-700 text-white rounded-lg hover:bg-gray-800">
                                Subscribe
                            </button>
                        </div>

                        <!-- Quarterly Tier - Most Popular -->
                        <div class="border-2 border-red-600 rounded-lg p-6 text-center relative">
                            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-3 py-1 rounded-full text-sm">
                                Most Popular
                            </div>
                            <h3 class="text-xl font-bold mb-2">Quarterly</h3>
                            <div class="text-3xl font-bold text-red-600 mb-2" id="quarterlyPrice">$99</div>
                            <div class="text-sm text-gray-600 mb-2" id="quarterlyDiscountText">per quarter</div>
                            <div class="text-gray-600 mb-4">Unlimited Evaluations</div>
                            <button onclick="subscribeToTier('quarterly')" class="w-full py-2 px-4 text-white rounded-lg hover:bg-red-700"
                                    style="background-color: #d9042b;">
                                Subscribe
                            </button>
                        </div>

                        <!-- Annual Tier - Best Value -->
                        <div class="border-2 border-green-600 rounded-lg p-6 text-center relative">
                            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-3 py-1 rounded-full text-sm">
                                Best Value
                            </div>
                            <h3 class="text-xl font-bold mb-2">Annual</h3>
                            <div class="text-3xl font-bold text-green-600 mb-2" id="annualPrice">$324</div>
                            <div class="text-sm text-gray-600 mb-2" id="annualDiscountText">per year</div>
                            <div class="text-gray-600 mb-4">Unlimited Evaluations</div>
                            <button onclick="subscribeToTier('annual')" class="w-full py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Subscribe
                            </button>
                        </div>
                    </div>

                    <div class="mb-8 text-center text-sm text-gray-500">
                        Cancel anytime. Secure payment processing by Stripe.
                    </div>

                    <div class="text-center text-gray-500 mb-8">
                        <div class="flex items-center">
                            <div class="flex-1 border-t border-gray-300"></div>
                            <span class="px-4 text-sm">OR</span>
                            <div class="flex-1 border-t border-gray-300"></div>
                        </div>
                    </div>

                    <!-- Student Code Redemption Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-900 mb-4">Have a Student Code?</h3>
                        <p class="text-blue-700 mb-4">If you have a student code, enter it below to get free access or credits!</p>
                        <div class="flex space-x-3">
                            <input type="text" id="paymentPageStudentCode" placeholder="Enter your student code" 
                                   class="flex-1 px-4 py-3 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button id="redeemCodeBtn" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                                Redeem Code
                            </button>
                        </div>
                        <div id="codeRedemptionResult" class="mt-3 hidden"></div>
                    </div>

                </div>
            </div>

<script>
        // Initialize Stripe (TEST MODE)
        const stripe = Stripe('pk_test_51IAqQXGeynMWYbxDVS6wPalfpyuFfRknJN1xnYqmXGFT2B37foYZHdKYkMKohUZAgOOHflOGLYgiKev537GuOZKi00XO4MKDk9');
            
        // Global state
        let currentUser = null;
        let currentUserProfile = null;
        let currentView = 'login';
        let isLoading = false;
        let currentHistoryPage = 1;
        let historyPerPage = 10;
        let showAllHistory = false;
        let currentEvaluation = null;

// Phase management configuration
const PHASE_CONFIG = {
    currentPhase: 1,
    limits: {
        phase1: 25,
        phase2: 20,  // Additional users (45 total)
        phase3: 100, // Additional users (145 total)
        phase4: -1   // Unlimited (-1 means no limit)
    }
};

// Calculate total allowed users for current phase
function getTotalUserLimit() {
    switch(PHASE_CONFIG.currentPhase) {
        case 1: return PHASE_CONFIG.limits.phase1;
        case 2: return PHASE_CONFIG.limits.phase1 + PHASE_CONFIG.limits.phase2;
        case 3: return PHASE_CONFIG.limits.phase1 + PHASE_CONFIG.limits.phase2 + PHASE_CONFIG.limits.phase3;
        case 4: return -1; // Unlimited
        default: return PHASE_CONFIG.limits.phase1;
    }
}

// Check if registration should be blocked
async function checkRegistrationLimit() {
    const totalLimit = getTotalUserLimit();
    
    if (totalLimit === -1) {
        return { allowed: true }; // Phase 4 = unlimited
    }
    
    // Count current non-admin users
    const usersResult = await window.dbHelpers.getAllUsers();
    if (!usersResult.success) {
        return { allowed: true, error: 'Could not verify user count' };
    }
    
    const nonAdminUsers = usersResult.data.filter(user => !user.is_admin);
    const currentCount = nonAdminUsers.length;
    
    if (currentCount >= totalLimit) {
        return { 
            allowed: false, 
            currentCount: currentCount, 
            limit: totalLimit,
            phase: PHASE_CONFIG.currentPhase
        };
    }
    
    return { allowed: true, currentCount: currentCount, limit: totalLimit };
}
        
        // Utility Functions
        function checkPasswordStrength(password) {
            let strength = 0;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            strength = Object.values(requirements).filter(Boolean).length;
            
            if (strength < 3) return 'weak';
            if (strength < 5) return 'medium';
            return 'strong';
        }

        function updatePasswordStrength(passwordField, strengthElement) {
            const password = passwordField.value;
            const strength = checkPasswordStrength(password);
            
            strengthElement.className = 'password-strength password-' + strength;
            strengthElement.classList.remove('hidden');
        }

        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            return Object.values(requirements).every(Boolean);
        }

        function calculateDaysRemaining(expiryDate) {
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        function truncateLogline(logline, maxLength) {
            maxLength = maxLength || 50;
            if (logline.length <= maxLength) return logline;
            return logline.substring(0, maxLength) + '...';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

    // Initialize app
document.addEventListener('DOMContentLoaded', async function() {
    // Check for password reset token in URL FIRST
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('reset');
    
    if (resetToken) {
        // Show password reset form instead of normal login
        showPasswordResetForm(resetToken);
        return; // Exit early, don't load normal app
    }

     // ADD THIS NEW SECTION FOR PAYMENT SUCCESS
    const paymentSuccess = urlParams.get('payment');
    const sessionId = urlParams.get('session_id');
    const creditAmount = urlParams.get('amount');
    const userId = urlParams.get('user_id');

    if (paymentSuccess === 'success' && sessionId && creditAmount && userId) {
        handlePaymentSuccess(sessionId, userId, parseInt(creditAmount));
        return; // Exit early to handle payment success
    }
    // END NEW SECTION
    
    // Check for customer portal return
const portalReturn = urlParams.get('portal');
if (portalReturn === 'return') {
    // Clean the URL and show a success message
    window.history.replaceState({}, document.title, window.location.pathname);
    setTimeout(() => {
        alert('Payment management completed successfully!');
    }, 500);
}
    
    // Wait for Supabase to be loaded
    let attempts = 0;
    while (!window.authHelpers && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (!window.authHelpers) {
        console.error('Supabase not loaded properly');
        alert('System initialization error. Please refresh the page.');
        return;
    }
    
    // Check for existing session
    const authResult = await window.authHelpers.getCurrentUser();
    if (authResult.success && authResult.data) {
        // User is logged in, get their profile
        const profileResult = await window.dbHelpers.getUserProfile(authResult.data.id);
        if (profileResult.success) {
            currentUser = authResult.data;
            currentUserProfile = profileResult.data;
            showApp();
        } else {
            // User exists but no profile - this shouldn't happen in normal flow
            console.error('User has no profile:', profileResult.error);
            await window.authHelpers.signOut();
        }
    }
    
    setupEventListeners();
    updateUI();
});

        function setupEventListeners() {
            // Auth listeners
            document.getElementById('authToggle').addEventListener('click', toggleAuthMode);
            document.getElementById('authSubmit').addEventListener('click', handleAuth);
            document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
            document.getElementById('forgotPasswordBtn').addEventListener('click', showPasswordReset);
            document.getElementById('sendResetBtn').addEventListener('click', sendPasswordReset);
            document.getElementById('cancelResetBtn').addEventListener('click', hidePasswordReset);
            
            // Navigation listeners
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('loglineBtn').addEventListener('click', function() { showSection('logline'); });
            document.getElementById('historyBtn').addEventListener('click', function() { showSection('history'); });
            document.getElementById('settingsBtn').addEventListener('click', function() { showSection('settings'); });
            
            // App listeners
            document.getElementById('evaluateBtn').addEventListener('click', evaluateLogline);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadEvaluationPDF);
            
            // History listeners
            document.getElementById('showAllHistoryBtn').addEventListener('click', toggleShowAllHistory);
            
            // Settings listeners
            document.getElementById('updateEmailBtn').addEventListener('click', updateEmail);
            document.getElementById('updatePasswordBtn').addEventListener('click', updatePassword);
            document.getElementById('managePaymentBtn').addEventListener('click', managePayment);
            document.getElementById('buyMoreCreditsBtn').addEventListener('click', function() { showSection('purchase'); });
            
            // Admin listeners
            document.getElementById('generateCodesBtn').addEventListener('click', generateStudentCodes);
            document.getElementById('downloadCodesBtn').addEventListener('click', downloadCodes);
            document.getElementById('downloadAllSubmissionsBtn').addEventListener('click', downloadAllSubmissions);
            document.getElementById('viewUsersBtn').addEventListener('click', viewAllUsers);
            document.getElementById('redeemCodeBtn').addEventListener('click', redeemStudentCode);
            document.getElementById('searchUserBtn').addEventListener('click', searchUser);
            document.getElementById('updateCreditsBtn').addEventListener('click', updateUserCredits);
            document.getElementById('setTimeBtn').addEventListener('click', setUserTime);
            document.getElementById('cancelEvaluationBtn').addEventListener('click', hideCreditConfirmation);
            document.getElementById('proceedEvaluationBtn').addEventListener('click', function() {
                hideCreditConfirmation();
                performEvaluation();
            });
            document.getElementById('startFreshBtn').addEventListener('click', clearLoglineForm);

            // Password strength listeners
            document.getElementById('authPassword').addEventListener('input', function() {
                if (currentView === 'register') {
                    updatePasswordStrength(this, document.getElementById('passwordStrength'));
                }
            });

            document.getElementById('newPassword').addEventListener('input', function() {
                updatePasswordStrength(this, document.getElementById('newPasswordStrength'));
            });
        }

        // Authentication Functions
        function toggleAuthMode() {
            currentView = currentView === 'login' ? 'register' : 'login';
            const registerFields = document.getElementById('registerFields');
            const subtitle = document.getElementById('authSubtitle');
            const buttonText = document.getElementById('authButtonText');
            const toggleText = document.getElementById('authToggle');
            const passwordRequirements = document.getElementById('passwordRequirements');

            if (currentView === 'register') {
                registerFields.classList.remove('hidden');
                passwordRequirements.classList.remove('hidden');
                subtitle.textContent = 'Create your account';
                buttonText.textContent = 'Create Account';
                toggleText.textContent = 'Already have an account? Sign in';
            } else {
                registerFields.classList.add('hidden');
                passwordRequirements.classList.add('hidden');
                subtitle.textContent = 'Sign in to your account';
                buttonText.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account? Sign up";
            }
        }

        function togglePasswordVisibility() {
            const passwordField = document.getElementById('authPassword');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.textContent = 'üôà';
            } else {
                passwordField.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
            }
        }

        function showPasswordReset() {
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function hidePasswordReset() {
            document.getElementById('resetModal').classList.add('hidden');
            document.getElementById('resetEmail').value = '';
        }

function showPasswordResetForm(token) {
    // Hide the normal page content
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('appSection').style.display = 'none';
    
    // Create password reset form
    document.body.innerHTML = `
        <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
            <div class="max-w-md w-full space-y-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="text-center mb-6">
                        <img src="logo.png" alt="BRS Labs" style="height: 48px; margin: 0 auto 20px;">
                        <h2 class="text-2xl font-bold text-gray-900">Reset Your Password</h2>
                        <p class="text-gray-600">Enter your new password below</p>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="password" id="newPasswordReset" placeholder="New password" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <input type="password" id="confirmPasswordReset" placeholder="Confirm new password" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <button onclick="updatePasswordFromReset('${token}')" 
                                class="w-full py-3 px-4 bg-red-600 text-white font-medium rounded-md hover:bg-red-700"
                                style="background-color: #d9042b;">
                            Update Password
                        </button>
                        <div class="text-center">
                            <a href="${window.location.origin}" class="text-red-600 hover:text-red-500 text-sm">
                                Back to Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function updatePasswordFromReset(token) {
    const newPassword = document.getElementById('newPasswordReset').value;
    const confirmPassword = document.getElementById('confirmPasswordReset').value;
    
    if (!newPassword || !confirmPassword) {
        alert('Please fill in both password fields');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
    }
    
    // TODO: In real implementation, validate token and update password via Supabase
    // For now, we'll just redirect to login
    alert('Password reset functionality requires Supabase auth flow setup. Please contact support.');
    window.location.href = window.location.origin;
}

        async function sendPasswordReset() {
            const email = document.getElementById('resetEmail').value;
            if (!email) {
                alert('Please enter your email address');
                return;
            }

            const result = await window.authHelpers.resetPassword(email);
            if (result.success) {
                alert('Password reset link sent to your email!');
                hidePasswordReset();
            } else {
                alert('Failed to send reset email: ' + result.error);
            }
        }

        async function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            if (!email || !password) {
                alert('Please fill in all required fields');
                return;
            }

           if (currentView === 'register') {
                const confirmPassword = document.getElementById('confirmPassword').value;
                const studentCode = document.getElementById('studentCode').value;

                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }

                if (!validatePassword(password)) {
                    alert('Password does not meet requirements');
                    return;
                }

                await register(email, password, studentCode);
            } else {
                await login(email, password);
            }
        }

        async function login(email, password) {
            setLoading(true);
            
            const authResult = await window.authHelpers.signIn(email, password);
            
            if (authResult.success) {
                // Get user profile
                const profileResult = await window.dbHelpers.getUserProfile(authResult.data.user.id);
                
                if (profileResult.success) {
                    // Check if user is suspended or deleted
                    const status = profileResult.data.status || 'active';
                    if (status === 'suspended') {
                        alert('Your account has been suspended. Please contact support.');
                        await window.authHelpers.signOut();
                        setLoading(false);
                        return;
                    }
                    if (status === 'deleted') {
                        alert('This account no longer exists. Please contact support.');
                        await window.authHelpers.signOut();
                        setLoading(false);
                        return;
                    }
                    
                    currentUser = authResult.data.user;
                    currentUserProfile = profileResult.data;
                    showApp();
                } else {
                    alert('Profile not found. Please contact support.');
                    await window.authHelpers.signOut();
                }
            } else {
                alert('Invalid email or password');
            }
            
            setLoading(false);
        }

    async function register(email, password, studentCode) {
            setLoading(true);

 // Check registration limits first
const limitCheck = await checkRegistrationLimit();
if (!limitCheck.allowed) {
    alert(`Registration is currently full. Please join our waitlist!`);
    // Redirect to Kit waitlist form after they click OK
    window.open('https://successful-innovator-3133.kit.com/7b7bff4c4d', '_blank');
    setLoading(false);
    return;
}
        
            try {
                // Step 1: Validate student code first (if provided)
                let validatedCode = null;
                
                if (studentCode) {
                    const codeResult = await window.dbHelpers.getStudentCode(studentCode);
                    if (!codeResult.success) {
                        alert('Invalid or already used student code');
                        setLoading(false);
                        return;
                    }
                    validatedCode = codeResult.data;
                }
                
                // Step 2: Create auth user (trigger will automatically create profile)
                const authResult = await window.authHelpers.signUp(email, password);
                
                if (!authResult.success) {
                    alert('Failed to create account: ' + authResult.error);
                    setLoading(false);
                    return;
                }
                
                // Check if user was actually created
                if (!authResult.data.user) {
                    alert('Account creation failed - no user returned from authentication service');
                    setLoading(false);
                    return;
                }
                
                const newUserId = authResult.data.user.id;
                
                // Step 3: Get the profile that was automatically created by the trigger
                // Give it a moment to be created
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const profileResult = await window.dbHelpers.getUserProfile(newUserId);
                
                if (!profileResult.success) {
                    console.error('Profile not found after user creation:', profileResult.error);
                    await window.authHelpers.signOut();
                    alert('Account setup failed. Please try again.');
                    setLoading(false);
                    return;
                }
                
                let userProfile = profileResult.data;
                
          // Step 4: If student code was provided, update the profile
                if (validatedCode) {
                    let updateData = {};
                    
                    if (validatedCode.code_type === 'credit_based') {
                        // Credit-based code: add credits, keep as 'credits' type
                        updateData = {
                            credits: validatedCode.credits
                        };
                    } else {
                        // Time-based code: set as student with expiry
                        const expiry = new Date();
                        expiry.setMonth(expiry.getMonth() + validatedCode.months);
                        updateData = {
                            user_type: 'student',
                            access_expiry: expiry.toISOString()
                        };
                    }
                    
                    const updateResult = await window.supabase
                        .from('user_profiles')
                        .update(updateData)
                        .eq('id', newUserId)
                        .select()
                        .single();
                    
                    if (updateResult.error) {
                        console.error('Failed to update profile for student code:', updateResult.error);
                        // Continue anyway - basic account is created
                    } else {
                        userProfile = updateResult.data;
                    }
                    
                    // Mark student code as used
                    const codeUseResult = await window.dbHelpers.useStudentCode(studentCode, newUserId);
                    if (!codeUseResult.success) {
                        console.warn('Failed to mark student code as used:', codeUseResult.error);
                    }
                }
                
                // Step 5: For admin users, make sure they have unlimited credits
                if (userProfile.is_admin) {
                    const adminUpdateResult = await window.supabase
                        .from('user_profiles')
                        .update({ credits: 999999 })
                        .eq('id', newUserId)
                        .select()
                        .single();
                    
                    if (adminUpdateResult.error) {
                        console.error('Failed to set admin credits:', adminUpdateResult.error);
                    } else {
                        userProfile = adminUpdateResult.data;
                    }
                }
                
                // Step 6: Set current user data
                currentUser = authResult.data.user;
                currentUserProfile = userProfile;
                
              // Step 7: Send welcome email
                await sendWelcomeEmail(userProfile.user_type, userProfile.credits, userProfile.access_expiry);
                
// Step 8: Success!
alert('Account created successfully! Welcome to the Logline Evaluator.');
showApp();
                
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed: ' + error.message);
                
                // Try to clean up any partial state
                await window.authHelpers.signOut();
            }
            
            setLoading(false);
        }

        function setLoading(loading) {
            isLoading = loading;
            const button = document.getElementById('authSubmit');
            const spinner = document.getElementById('authSpinner');
            
            button.disabled = loading;
            if (loading) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

       async function showApp() {
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('appSection').classList.remove('hidden');
    
    // Check if student user has expired and needs conversion
    await checkAndConvertExpiredStudent();
    
    // Check if user should be redirected to purchase page
    if (shouldRedirectToPurchase()) {
        showSection('purchase');
        setTimeout(function() {
            if (isNewUser()) {
                alert('Welcome! To get started, you\'ll need to purchase some credits to evaluate your loglines.');
            } else {
                alert('You\'re out of credits! Purchase more to continue using the logline evaluator.');
            }
        }, 500);
    } else {
        showSection('logline');
    }
    
    updateUI();
    loadLastSubmissionData();
}

        async function showSection(section) {
            document.getElementById('loglineSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('purchaseSection').classList.add('hidden');

            if (section === 'logline') {
                document.getElementById('loglineSection').classList.remove('hidden');
                loadUserFormData();
                checkAndShowGettingStarted();
            } else if (section === 'history') {
                document.getElementById('historySection').classList.remove('hidden');
                loadHistory();
            } else if (section === 'settings') {
                document.getElementById('settingsSection').classList.remove('hidden');
                loadSettings();
            } else if (section === 'purchase') {
                document.getElementById('purchaseSection').classList.remove('hidden');
                await updatePurchaseSection();
            } else if (section === 'results') {
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

       function updateUI() {
    if (!currentUserProfile) return;

    const userStatus = document.getElementById('userStatus');
    
    if (currentUserProfile.user_type === 'subscriber') {
        if (currentUserProfile.subscription_status === 'active') {
            userStatus.textContent = 'Active Subscription';
            userStatus.className = 'text-sm font-medium text-green-600';
            userStatus.onclick = null;
        } else if (currentUserProfile.subscription_status === 'past_due') {
            userStatus.textContent = 'Payment Required';
            userStatus.className = 'text-sm font-medium text-red-600 hover:text-red-800 cursor-pointer underline';
            userStatus.onclick = function() { showSection('purchase'); };
        } else {
            userStatus.textContent = 'Manage Subscription';
            userStatus.className = 'text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer underline';
            userStatus.onclick = function() { showSection('purchase'); };
        }
    } else if (currentUserProfile.user_type === 'credits') {
                userStatus.textContent = currentUserProfile.credits + ' credits remaining';
                userStatus.className = 'text-sm font-medium text-blue-600 hover:text-blue-800 cursor-pointer underline';
                userStatus.onclick = function() {
                    showSection('purchase');
                };
            } else if (currentUserProfile.user_type === 'student') {
                const daysLeft = calculateDaysRemaining(currentUserProfile.access_expiry);
                userStatus.textContent = daysLeft + ' days remaining';
                userStatus.className = 'text-sm font-medium text-green-600';
                userStatus.onclick = null;
            } else if (currentUserProfile.user_type === 'admin') {
                userStatus.textContent = 'Unlimited access';
                userStatus.className = 'text-sm font-medium text-purple-600';
                userStatus.onclick = null;
            }
        }
        async function loadSettings() {
            document.getElementById('newEmail').value = currentUser.email;
            
            // Hide all payment sections first
            document.getElementById('creditUserPayment').classList.add('hidden');
            document.getElementById('studentUserPayment').classList.add('hidden');
            document.getElementById('adminUserPayment').classList.add('hidden');
            document.getElementById('adminSettings').classList.add('hidden');
            
            if (currentUserProfile.user_type === 'credits') {
                document.getElementById('creditUserPayment').classList.remove('hidden');
                document.getElementById('currentCredits').textContent = currentUserProfile.credits;
            } else if (currentUserProfile.user_type === 'subscriber') {
    document.getElementById('subscriberUserPayment').classList.remove('hidden');
    const status = currentUserProfile.subscription_status || 'unknown';
    document.getElementById('subscriptionStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
    if (status === 'active') {
        document.getElementById('subscriptionStatus').className = 'font-semibold text-green-600';
    } else if (status === 'past_due') {
        document.getElementById('subscriptionStatus').className = 'font-semibold text-red-600';
    } else {
        document.getElementById('subscriptionStatus').className = 'font-semibold text-gray-600';
    }
            } else if (currentUserProfile.user_type === 'student') {
                document.getElementById('studentUserPayment').classList.remove('hidden');
                const daysLeft = calculateDaysRemaining(currentUserProfile.access_expiry);
                document.getElementById('studentDaysLeft').textContent = daysLeft;
            }
            
            // Show admin sections ONLY if user is actually an admin
            if (currentUserProfile.is_admin === true) {
                document.getElementById('adminUserPayment').classList.remove('hidden');
                document.getElementById('adminSettings').classList.remove('hidden');
                await updateAdminSection();
            }
        }
        
        async function updateAdminSection() {
            // Get all users (excluding admins)
            const usersResult = await window.dbHelpers.getAllUsers();
            const totalUsers = usersResult.success ? usersResult.data.filter(u => !u.is_admin).length : 0;
            
            // Get all submissions
            const submissionsResult = await window.dbHelpers.getAllSubmissions();
            const totalEvaluations = submissionsResult.success ? submissionsResult.data.length : 0;
            
            // Get all student codes
            const codesResult = await window.dbHelpers.getAllStudentCodes();
            const totalCodes = codesResult.success ? codesResult.data.length : 0;
            
           // Calculate users by phase (simplified - just show current totals)
            const currentPhase = PHASE_CONFIG.currentPhase;
            const currentLimit = getTotalUserLimit();
            const limitText = currentLimit === -1 ? 'Unlimited' : currentLimit;

            document.getElementById('totalUsers').textContent = `${totalUsers} / ${limitText}`;
            document.getElementById('totalEvaluations').textContent = totalEvaluations;

            // Add phase info
            document.getElementById('totalUsers').parentElement.querySelector('.text-sm').textContent = `Phase ${currentPhase} Users`;
            document.getElementById('codesCount').textContent = totalCodes;
            document.getElementById('submissionsCount').textContent = totalEvaluations;
            document.getElementById('userCount').textContent = totalUsers;
        }

        // Core App Functions
       // Updated evaluateLogline function with credit confirmation
        async function evaluateLogline() {
            const formData = {
                genre: document.getElementById('genre').value,
                tone: document.getElementById('tone').value,
                mainCharacter: document.getElementById('mainCharacter').value,
                antagonist: document.getElementById('antagonist').value,
                incitingIncident: document.getElementById('incitingIncident').value,
                storyDetails: document.getElementById('storyDetails').value,
                logline: document.getElementById('logline').value
            };

            if (!formData.genre || !formData.tone || !formData.mainCharacter || !formData.antagonist || !formData.incitingIncident || !formData.storyDetails || !formData.logline) {
                alert('Please fill in all fields before submitting.');
                return;
            }

           // Check subscription status for subscribers
            if (currentUserProfile.user_type === 'subscriber') {
                if (currentUserProfile.subscription_status !== 'active') {
                    alert('Your subscription is not active. Please update your payment method or resubscribe.');
                    showSection('purchase');
                    return;
                }
            }

            // Legacy credits users must subscribe
            if (currentUserProfile.user_type === 'credits') {
                alert('Credit-based access has ended. Please subscribe for unlimited evaluations.');
                showSection('purchase');
                return;
            }

            // Student users - check if expired
            if (currentUserProfile.user_type === 'student') {
                if (new Date(currentUserProfile.access_expiry) < new Date()) {
                    alert('Your student access has expired. Please subscribe to continue.');
                    showSection('purchase');
                    return;
                }
            }

            // Admin and valid students/subscribers proceed directly
            performEvaluation(formData);
        }

        function showCreditConfirmation() {
            document.getElementById('modalCreditsRemaining').textContent = currentUserProfile.credits;
            document.getElementById('creditConfirmModal').classList.remove('hidden');
        }

        function hideCreditConfirmation() {
            document.getElementById('creditConfirmModal').classList.add('hidden');
        }

        async function performEvaluation(formData) {
            // Check student status before proceeding
if (currentUserProfile.user_type === 'student') {
    const now = new Date();
    const expiry = new Date(currentUserProfile.access_expiry);
    
    if (expiry <= now) {
        alert('Your student access has expired. Please wait while we convert your account...');
        await checkAndConvertExpiredStudent();
        
        if (currentUserProfile.credits <= 0) {
            showSection('purchase');
            alert('You\'ve been converted to a credits user but need to purchase credits to continue.');
            return;
        }
    }
}
            // If formData not provided, get it from the form
            if (!formData) {
                formData = {
                    genre: document.getElementById('genre').value,
                    tone: document.getElementById('tone').value,
                    mainCharacter: document.getElementById('mainCharacter').value,
                    antagonist: document.getElementById('antagonist').value,
                    incitingIncident: document.getElementById('incitingIncident').value,
                    storyDetails: document.getElementById('storyDetails').value,
                    logline: document.getElementById('logline').value
                };
            }

            const button = document.getElementById('evaluateBtn');
            const text = document.getElementById('evaluateText');
            const spinner = document.getElementById('evaluateSpinner');
            
            button.disabled = true;
            text.textContent = 'Evaluating Your Logline...';
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('/.netlify/functions/evaluate-logline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ formData: formData })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error('Backend error: ' + response.status + ' - ' + errorData.error);
                }

                const data = await response.json();
                const claudeResponse = data.evaluation;

            // No credit deduction for subscribers - they have unlimited access
                // Legacy credit users are handled in pre-evaluation checks
                
             // Save submission to database
const submissionResult = await window.dbHelpers.createSubmission(
    currentUser.id,
    formData,
    claudeResponse
);

           if (submissionResult.success) {
    currentEvaluation = submissionResult.data;
    
    // Save form data after successful submission
    saveCurrentFormData();
    
            } else {
                console.error('Failed to save submission:', submissionResult.error);
            }

                document.getElementById('originalLogline').textContent = '"' + formData.logline + '"';
                document.getElementById('evaluationResult').textContent = claudeResponse;
                
                showSection('results');
                updateUI();

            } catch (error) {
                console.error('Error evaluating logline:', error);
                alert('Sorry, there was an error evaluating your logline. Please try again.');
            } finally {
                button.disabled = false;
                text.textContent = 'Get My Evaluation';
                spinner.classList.add('hidden');
            }
        }
        
        function resetForm() {
            document.getElementById('genre').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('mainCharacter').value = '';
            document.getElementById('antagonist').value = '';
            document.getElementById('incitingIncident').value = '';
            document.getElementById('storyDetails').value = '';
            document.getElementById('logline').value = '';
            
            showSection('logline');
        }

// Purchase Functions
        async function updatePurchaseSection() {
            // Clear any previous code redemption results
            const resultDiv = document.getElementById('codeRedemptionResult');
            if (resultDiv) {
                resultDiv.classList.add('hidden');
                resultDiv.textContent = '';
            }
            
            // Check if user already has active subscription
            if (currentUserProfile.user_type === 'subscriber' && currentUserProfile.subscription_status === 'active') {
                // Hide subscription tiers and show management message
                document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3').style.display = 'none';
                document.getElementById('subscriptionDiscountBanner').style.display = 'none';
                
                // Show active subscription message
                const purchaseSection = document.getElementById('purchaseSection');
                const existingMessage = document.getElementById('activeSubscriptionMessage');
                if (!existingMessage) {
                    const messageHTML = `
                        <div id="activeSubscriptionMessage" class="bg-green-50 border-2 border-green-500 rounded-lg p-8 mb-8 text-center">
                            <div class="text-green-600 text-5xl mb-4">‚úì</div>
                            <h3 class="text-2xl font-bold text-green-900 mb-2">You Have an Active Subscription</h3>
                            <p class="text-green-700 mb-6">You currently have unlimited access to the Logline Evaluator.</p>
                            <button onclick="managePayment()" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                                Manage Your Subscription
                            </button>
                        </div>
                    `;
                    purchaseSection.querySelector('.bg-white').insertAdjacentHTML('afterbegin', messageHTML);
                }
                return;
            } else {
                // Remove active subscription message if it exists
                const existingMessage = document.getElementById('activeSubscriptionMessage');
                if (existingMessage) {
                    existingMessage.remove();
                }
                // Show subscription tiers
                document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3').style.display = 'grid';
            }
            
            // Update subscription pricing based on phase
            updateSubscriptionPricing();
        }

        async function updateSubscriptionPricing() {
            const phase = PHASE_CONFIG.currentPhase;
            let discount = 0;
            let bannerColor = '';
            let bannerTitle = '';
            let bannerMessage = '';
            
            // Determine discount based on phase
            if (phase <= 2) {
                discount = 0.5;
                bannerColor = 'bg-green-50 border-green-200';
                bannerTitle = 'üéâ Beta Adopter Discount!';
                bannerMessage = 'Get 50% off your first payment as an early adopter!';
            } else if (phase === 3) {
                discount = 0.25;
                bannerColor = 'bg-blue-50 border-blue-200';
                bannerTitle = 'üöÄ Early Adopter Discount!';
                bannerMessage = 'Get 25% off your first payment!';
            }
            
            // Show/hide banner
            const banner = document.getElementById('subscriptionDiscountBanner');
            if (discount > 0) {
                banner.className = `${bannerColor} border rounded-lg p-4 mb-10 text-center`;
                document.getElementById('discountTitle').textContent = bannerTitle;
                document.getElementById('discountTitle').className = `font-bold text-lg ${phase <= 2 ? 'text-green-800' : 'text-blue-800'}`;
                document.getElementById('discountMessage').textContent = bannerMessage;
                document.getElementById('discountMessage').className = `text-base font-medium ${phase <= 2 ? 'text-green-700' : 'text-blue-700'}`;
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
            
            // Calculate and display prices
            const monthlyBase = 36;
            const quarterlyBase = 99;
            const annualBase = 324;
            
            const monthlyDiscounted = Math.floor(monthlyBase * (1 - discount));
            const quarterlyDiscounted = (quarterlyBase * (1 - discount)).toFixed(2);
            const annualDiscounted = Math.floor(annualBase * (1 - discount));
            
            // Update monthly pricing
            if (discount > 0) {
                document.getElementById('monthlyPrice').innerHTML = 
                    `<span class="line-through text-gray-400">$${monthlyBase}</span> $${monthlyDiscounted}`;
                document.getElementById('monthlyDiscountText').textContent = 
                    `First month only, then $${monthlyBase}/mo`;
            } else {
                document.getElementById('monthlyPrice').textContent = `$${monthlyBase}`;
                document.getElementById('monthlyDiscountText').textContent = 'per month';
            }
            
            // Update quarterly pricing
            if (discount > 0) {
                document.getElementById('quarterlyPrice').innerHTML = 
                    `<span class="line-through text-gray-400">$${quarterlyBase}</span> $${quarterlyDiscounted}`;
                document.getElementById('quarterlyDiscountText').textContent = 
                    `First quarter: $${quarterlyDiscounted}, then $${quarterlyBase}`;
            } else {
                document.getElementById('quarterlyPrice').textContent = `$${quarterlyBase}`;
                document.getElementById('quarterlyDiscountText').textContent = 'per quarter';
            }
            
            // Update annual pricing
            if (discount > 0) {
                document.getElementById('annualPrice').innerHTML = 
                    `<span class="line-through text-gray-400">$${annualBase}</span> $${annualDiscounted}`;
                document.getElementById('annualDiscountText').textContent = 
                    `First year: $${annualDiscounted}, then $${annualBase}`;
            } else {
                document.getElementById('annualPrice').textContent = `$${annualBase}`;
                document.getElementById('annualDiscountText').textContent = 'per year';
            }
        }

        async function subscribeToTier(tier) {
            const priceIds = {
                'monthly': 'price_1SAJauGeynMWYbxDxk5dJdUt',
                'quarterly': 'price_1SAJduGeynMWYbxDV165lpnX',
                'annual': 'price_1SAJfIGeynMWYbxDn9hm2WZN'
            };
            
            const priceId = priceIds[tier];
            if (!priceId) {
                alert('Invalid subscription tier');
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceId,
                        userEmail: currentUser.email,
                        userId: currentUser.id
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to create subscription session');
                }
                
                const { error } = await stripe.redirectToCheckout({
                    sessionId: result.sessionId
                });
                
                if (error) {
                    console.error('Stripe redirect error:', error);
                    alert('Error redirecting to payment: ' + error.message);
                }
                
            } catch (error) {
                console.error('Subscription error:', error);
                alert('Error starting subscription: ' + error.message);
            }
        }

        async function loadHistory() {
            const submissionsResult = await window.dbHelpers.getUserSubmissions(currentUser.id);
            
            if (!submissionsResult.success || submissionsResult.data.length === 0) {
                document.getElementById('noHistory').classList.remove('hidden');
                document.getElementById('historyList').innerHTML = '';
                return;
            }
            
            document.getElementById('noHistory').classList.add('hidden');
            
            // Sort submissions by date (newest first)
            const sortedSubmissions = submissionsResult.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Apply pagination
            const totalItems = sortedSubmissions.length;
            const totalPages = Math.ceil(totalItems / historyPerPage);
            const startIndex = (currentHistoryPage - 1) * historyPerPage;
            const endIndex = startIndex + historyPerPage;
            const pageSubmissions = showAllHistory ? sortedSubmissions : sortedSubmissions.slice(startIndex, endIndex);
            
            // Generate history list HTML
            const historyHTML = pageSubmissions.map(submission => {
                const date = new Date(submission.timestamp).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="history-item border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer"
                         onclick="viewHistoryItem('${submission.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h3 class="font-medium text-gray-900 mb-1">
                                    ${truncateLogline(submission.form_data.logline, 80)}
                                </h3>
                                <p class="text-sm text-gray-600">
                                    <span class="font-medium">Genre:</span> ${submission.form_data.genre} | 
                                    <span class="font-medium">Tone:</span> ${submission.form_data.tone}
                                </p>
                            </div>
                            <div class="text-right ml-4">
                                <p class="text-sm text-gray-500">${date}</p>
                                <div class="flex space-x-2 mt-1">
                                    <button onclick="event.stopPropagation(); downloadHistoryPDF('${submission.id}')" 
                                            class="text-blue-600 hover:text-blue-800 text-xs">
                                        PDF
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteHistoryItem('${submission.id}')" 
                                            class="text-red-600 hover:text-red-800 text-xs">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 line-clamp-2">
                            ${truncateLogline(submission.claude_response, 150)}
                        </p>
                    </div>
                `;
            }).join('');
            
            document.getElementById('historyList').innerHTML = historyHTML;
            
            // Update pagination
            if (!showAllHistory && totalPages > 1) {
                updateHistoryPagination(totalPages);
            } else {
                document.getElementById('historyPagination').innerHTML = '';
            }
        }

        function toggleShowAllHistory() {
            showAllHistory = !showAllHistory;
            currentHistoryPage = 1;
            const button = document.getElementById('showAllHistoryBtn');
            button.textContent = showAllHistory ? 'Show Paginated' : 'Show All';
            loadHistory();
        }

        function downloadEvaluationPDF() {
            if (!currentEvaluation) {
                alert('No evaluation data available to download');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up the document
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const maxWidth = pageWidth - (margin * 2);
                let yPosition = margin;
                
                // Helper function to check if we need a new page
                function checkPageBreak(neededSpace = 20) {
                    if (yPosition + neededSpace > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }
                
                // Helper function to add text with proper page breaks
                function addText(text, fontSize = 12, isBold = false, addSpacing = 5) {
                    doc.setFontSize(fontSize);
                    if (isBold) {
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFont(undefined, 'normal');
                    }
                    
                    const lines = doc.splitTextToSize(text, maxWidth);
                    const lineHeight = fontSize * 0.4;
                    const totalHeight = lines.length * lineHeight + addSpacing;
                    
                    // Check if this text block will fit on current page
                    if (yPosition + totalHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    // Add the text
                    for (let i = 0; i < lines.length; i++) {
                        // Double-check for each line in case of very long paragraphs
                        if (yPosition + lineHeight > pageHeight - margin) {
                            doc.addPage();
                            yPosition = margin;
                        }
                        doc.text(lines[i], margin, yPosition);
                        yPosition += lineHeight;
                    }
                    
                    yPosition += addSpacing;
                }
                
                // Helper function to add large text blocks (like evaluation results)
                function addLargeTextBlock(text, fontSize = 11) {
                    // Split into paragraphs first
                    const paragraphs = text.split('\n\n');
                    
                    for (let i = 0; i < paragraphs.length; i++) {
                        const paragraph = paragraphs[i].trim();
                        if (paragraph.length === 0) continue;
                        
                        // Check if this looks like a heading (short line, often numbered)
                        const isHeading = paragraph.length < 100 && (
                            paragraph.match(/^\d+\./) || 
                            paragraph.includes('Alternative') ||
                            paragraph.includes('Title') ||
                            paragraph.includes('Feedback') ||
                            paragraph.includes('Summary')
                        );
                        
                        if (isHeading) {
                            // Add extra space before headings and keep with next paragraph
                            checkPageBreak(40);
                            addText(paragraph, fontSize + 1, true, 8);
                        } else {
                            addText(paragraph, fontSize, false, 6);
                        }
                    }
                }
                
                // Add header
                addText('BRS Labs - Logline Evaluation Report', 16, true, 10);
                
                // Add date
                addText('Generated: ' + new Date(currentEvaluation.timestamp).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }), 10, false, 15);
                
                // Add original logline
                addText('Your Original Logline:', 14, true, 5);
                addText('"' + currentEvaluation.form_data.logline + '"', 12, false, 15);
                
                // Add form data
                addText('Project Details:', 14, true, 5);
                addText('Genre: ' + currentEvaluation.form_data.genre, 11, false, 3);
                addText('Tone: ' + currentEvaluation.form_data.tone, 11, false, 3);
                addText('Protagonist: ' + currentEvaluation.form_data.mainCharacter, 11, false, 3);
                addText('Antagonist: ' + currentEvaluation.form_data.antagonist, 11, false, 3);
                addText('Setup/Inciting Incident: ' + currentEvaluation.form_data.incitingIncident, 11, false, 3);
                addText('Story Details: ' + currentEvaluation.form_data.storyDetails, 11, false, 15);
                
                // Add evaluation results with smart page breaks
                addText('Evaluation Results:', 14, true, 8);
                addLargeTextBlock(currentEvaluation.claude_response, 11);
                
                // Add footer on a new section
                yPosition += 15;
                checkPageBreak(30);
                addText('Generated by BRS Labs Logline Evaluator', 10, false, 3);
                addText('For more screenwriting resources, visit: https://sales.bigredstripe.com/crucible/', 10, false, 3);
                
                // Generate filename with date
                const dateStr = new Date(currentEvaluation.timestamp).toLocaleDateString('en-US').replace(/\//g, '-');
                const filename = `Logline_Evaluation_${dateStr}.pdf`;
                
                // Save the PDF
                doc.save(filename);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        async function updateEmail() {
            const newEmail = document.getElementById('newEmail').value;

            // Validation
            if (!newEmail) {
                alert('Please enter a new email address');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                alert('Please enter a valid email address');
                return;
            }

            // TODO: Implement email update via Supabase auth
            alert('Email update functionality requires Supabase auth flow setup. Please contact support.');
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // Validation
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('Please fill in all password fields');
                return;
            }

            // Check new password confirmation
            if (newPassword !== confirmNewPassword) {
                alert('New passwords do not match');
                return;
            }

            // Validate new password strength
            if (!validatePassword(newPassword)) {
                alert('New password does not meet requirements: 8+ characters, uppercase, lowercase, number, special character');
                return;
            }

            // TODO: Implement password update via Supabase auth
            alert('Password update functionality requires Supabase auth flow setup. Please contact support.');
        }

        async function managePayment() {
            try {
                const response = await fetch('/.netlify/functions/create-customer-portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userEmail: currentUser.email,
                        userId: currentUser.id
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to access customer portal');
                }

                // Redirect to Stripe Customer Portal
                window.location.href = result.url;

            } catch (error) {
                console.error('Customer portal error:', error);
                alert('Error accessing payment management. Please try again. Error: ' + error.message);
            }
        }

      // UPDATED: Generate both time-based AND credit-based codes
        async function generateStudentCodes() {
    const quantity = parseInt(document.getElementById('codeQuantity').value) || 1;
    const months = parseInt(document.getElementById('codeMonths').value) || 3;
    
    if (!quantity || quantity < 1 || !months || months < 1) {
        alert('Please enter valid quantity and months');
        return;
    }
    
    try {
        const response = await fetch('/.netlify/functions/admin-generate-codes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                quantity: quantity,
                months: months,
                adminUserId: currentUser.id
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to generate codes');
        }
        
        await updateAdminSection();
        
        const codesList = result.codes.map(c => c.code).join('\n');
        alert(`Generated ${quantity} codes for ${months} months each!\n\nCodes:\n${codesList}`);
        
    } catch (error) {
        console.error('Code generation error:', error);
        alert('Failed to generate codes: ' + error.message);
    }
}

   // FIXED: Download codes with proper user info
       async function downloadCodes() {
    try {
        const response = await fetch('/.netlify/functions/admin-get-codes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                adminUserId: currentUser.id
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to load codes');
        }
        
        if (!result.codes || result.codes.length === 0) {
            alert('No student codes available to download');
            return;
        }
        
        const codesResult = { success: true, data: result.codes };

            // Create CSV content with proper user lookup
            const headers = ['Code', 'Type', 'Months', 'Credits', 'Created Date', 'Status', 'Used By Email', 'Used Date', 'Times Used'];
            
            // We need to get user emails for the used_by IDs
            const usersResult = await window.dbHelpers.getAllUsers();
            const userEmailMap = {};
            if (usersResult.success) {
                usersResult.data.forEach(user => {
                    userEmailMap[user.id] = user.email;
                });
            }
            
            const csvContent = [
                headers.join(','),
                ...codesResult.data.map(code => [
                    code.code,
                    code.code_type,
                    code.months || '',
                    code.credits || '',
                    formatDate(code.created_at),
                    code.used ? 'Used' : 'Available',
                    code.used_by ? userEmailMap[code.used_by] || 'Unknown User' : '',
                    code.used_at ? formatDate(code.used_at) : '',
                    code.times_used || 0
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `student_codes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadAllSubmissions() {
            const submissionsResult = await window.dbHelpers.getAllSubmissions();
            
            if (!submissionsResult.success || submissionsResult.data.length === 0) {
                alert('No submissions available to download');
                return;
            }

            // Create CSV content
            const headers = [
                'Submission ID',
                'User Email', 
                'Date',
                'Genre',
                'Tone',
                'Protagonist',
                'Antagonist',
                'Setup/Inciting Incident',
                'Story Details',
                'Original Logline',
                'Evaluation Response'
            ];
            
            const csvContent = [
                headers.join(','),
                ...submissionsResult.data.map(submission => [
                    `"${submission.id}"`,
                    `"${submission.user_profiles?.email || 'Unknown'}"`,
                    `"${formatDate(submission.timestamp)}"`,
                    `"${submission.form_data.genre}"`,
                    `"${submission.form_data.tone}"`,
                    `"${submission.form_data.mainCharacter.replace(/"/g, '""')}"`,
                    `"${submission.form_data.antagonist.replace(/"/g, '""')}"`,
                    `"${submission.form_data.incitingIncident.replace(/"/g, '""')}"`,
                    `"${submission.form_data.storyDetails.replace(/"/g, '""')}"`,
                    `"${submission.form_data.logline.replace(/"/g, '""')}"`,
                    `"${submission.claude_response.replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `all_submissions_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function viewAllUsers() {
            const usersResult = await window.dbHelpers.getAllUsers();
            
            if (!usersResult.success) {
                alert('Failed to load users: ' + usersResult.error);
                return;
            }
            
            const users = usersResult.data.filter(u => !u.is_admin);
            
            if (users.length === 0) {
                alert('No users have registered yet.');
                return;
            }
            
            // Create user management modal
            document.body.insertAdjacentHTML('beforeend', `
                <div id="userManagementModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-8 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-900">User Management</h3>
                                <button onclick="closeUserManagement()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Credits</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                                        ${users.map(user => createUserRow(user)).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        async function logout() {
            const result = await window.authHelpers.signOut();
            if (result.success) {
                currentUser = null;
                currentUserProfile = null;
                currentView = 'login';
                currentEvaluation = null;
                
                document.getElementById('appSection').classList.add('hidden');
                document.getElementById('authSection').classList.remove('hidden');
                
                document.getElementById('authEmail').value = '';
                document.getElementById('authPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('studentCode').value = '';
                
                if (currentView !== 'login') {
                    toggleAuthMode();
                }
            } else {
                console.error('Logout error:', result.error);
            }
        }

        async function handlePaymentSuccess(sessionId, userId, expectedAmount) {
            try {
                // Show loading state
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                            <div class="spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
                            <h2 class="text-xl font-semibold text-gray-900 mb-2">Processing your payment...</h2>
                            <p class="text-gray-600">Please wait while we verify your purchase.</p>
                        </div>
                    </div>
                `;

                // Verify payment with our backend
                const response = await fetch('/.netlify/functions/handle-payment-success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        userId: userId,
                        expectedAmount: expectedAmount
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Payment verification failed');
                }

                // Payment verified successfully, add credits to user account in Supabase
                if (window.dbHelpers) {
                    const userResult = await window.dbHelpers.getUserProfile(userId);
                    if (userResult.success) {
                        const newCredits = userResult.data.credits + result.creditAmount;
                        await window.dbHelpers.updateUserCredits(userId, newCredits);
                    }
                }

                // Show success message
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
                        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h2>
                            <p class="text-gray-600 mb-4">
                                ${result.creditAmount} credits have been added to your account.
                            </p>
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <p class="text-sm text-gray-600">
                                    Payment Amount: $${result.paymentAmount}<br>
                                    Credits Added: ${result.creditAmount}<br>
                                    Email: ${result.customerEmail}
                                </p>
                            </div>
                            <button onclick="redirectToApp()" 
                                    class="w-full py-3 px-4 bg-red-600 text-white font-medium rounded-md hover:bg-red-700"
                                    style="background-color: #d9042b;">
                                Continue to Logline Evaluator
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Payment processing error:', error);
                
                // Show error message
                document.body.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
                        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Processing Error</h2>
                            <p class="text-gray-600 mb-6">
                                There was an issue processing your payment. Please contact support if you were charged.
                            </p>
                            <p class="text-sm text-gray-500 mb-6">Error: ${error.message}</p>
                            <button onclick="redirectToApp()" 
                                    class="w-full py-3 px-4 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700">
                                Return to App
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function redirectToApp() {
            // Clean URL and redirect to main app
            const cleanUrl = window.location.origin;
            window.location.href = cleanUrl;
        }

        async function checkAndConvertExpiredStudent() {
    if (!currentUserProfile || currentUserProfile.user_type !== 'student') {
        return; // Not a student, no conversion needed
    }
    
    const now = new Date();
    const expiry = new Date(currentUserProfile.access_expiry);
    
    if (expiry > now) {
        return; // Student access still valid
    }
    
    // Student access has expired - require subscription purchase
    try {
        const updateResult = await window.supabase
            .from('user_profiles')
            .update({
                user_type: 'subscriber',
                subscription_status: 'expired',
                access_expiry: null
            })
            .eq('id', currentUser.id)
            .select()
            .single();
        
        if (!updateResult.error) {
            // Update local profile
            currentUserProfile = updateResult.data;
            
            // Send email notification
            await sendConversionEmail();
            
            // Show notification to user and redirect to purchase
            setTimeout(() => {
                alert('Your student access has expired. Please subscribe to continue using the Logline Evaluator.');
                showSection('purchase');
            }, 1000);
        }
    } catch (error) {
        console.error('Error converting expired student:', error);
    }
}

async function sendConversionEmail() {
    try {
        const templateParams = {
            to_email: currentUser.email,
            user_name: currentUser.email.split('@')[0],
            subject: 'Your BRS Labs Student Access Has Expired',
            message: `Hi ${currentUser.email.split('@')[0]},

Your student access to the Logline Evaluator has expired.

To continue using the Logline Evaluator, you'll need to subscribe for access.

Access the app here: ${window.location.origin}

Choose the subscription plan that works for you:
- Monthly: $36/month
- Quarterly: $99/quarter (save $9)
- Annual: $324/year (save $108)

All plans include unlimited logline evaluations for the duration of your subscription.

Thanks for using the Logline Evaluator!

Best regards,
The BRS Labs Team`
        };
        
   await emailjs.send('service_z3nppt7', 'template_8xpn9tn', {
    ...templateParams,
    timestamp: Date.now() // This forces EmailJS to treat it as a new request
});
    } catch (error) {
        console.error('Failed to send conversion email:', error);
    }
}

        async function sendWelcomeEmail(userType, credits = 0, accessExpiry = null) {
    try {
        let accessInfo;
        if (userType === 'student') {
            const expiry = new Date(accessExpiry);
            accessInfo = `You have unlimited access until ${expiry.toLocaleDateString()}. After that, you'll need to subscribe to continue using the evaluator.`;
        } else {
            accessInfo = `To get started, you'll need to subscribe for unlimited access. Choose from flexible monthly, quarterly, or annual plans.`;
        }

        const templateParams = {
            to_email: currentUser.email,
            user_name: currentUser.email.split('@')[0],
            subject: 'Welcome to the BRS Labs Logline Evaluator!',
            message: `Hi ${currentUser.email.split('@')[0]},

Welcome to the BRS Labs Logline Evaluator! We're excited to help you craft compelling loglines that grab Hollywood's attention.

üîñ IMPORTANT: Bookmark this link to easily access the evaluator:
${window.location.origin}

${accessInfo}

Ready to get started? Here are your next steps:
1. Click the link above to access the evaluator
2. Choose a subscription plan or redeem a student code if you have one
3. Fill out the logline form with your story details
4. Get instant professional feedback on your logline
5. Use the suggestions to refine and improve your logline

Need help? Check out our Getting Started guide or the FAQs at the bottom of the app... or contact us at support@bigredstripe.com

Happy writing!
The BRS Labs Team`,
            timestamp: Date.now()
        };
        
        await emailjs.send('service_z3nppt7', 'template_8xpn9tn', templateParams);
    } catch (error) {
        console.error('Failed to send welcome email:', error);
    }
}
        
        function shouldRedirectToPurchase() {
            // Only redirect credits users with 0 credits
            if (currentUserProfile && currentUserProfile.user_type === 'credits' && currentUserProfile.credits <= 0) {
                return true;
            }
            return false;
        }

        function isNewUser() {
            // This would need to be determined by checking submissions, but for now return false
            return false;
        }

        function createUserRow(user) {
            const status = user.status || 'active';
            const statusColor = status === 'active' ? 'text-green-600' : status === 'suspended' ? 'text-yellow-600' : 'text-red-600';
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);
            
            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.user_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.credits}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusColor}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(user.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        ${status === 'active' ? 
                            `<button onclick="suspendUser('${user.id}')" class="text-yellow-600 hover:text-yellow-900">Suspend</button>` :
                            status === 'suspended' ? 
                            `<button onclick="unsuspendUser('${user.id}')" class="text-green-600 hover:text-green-900">Unsuspend</button>` : ''
                        }
                        ${status !== 'deleted' ? 
                            `<button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">Delete</button>` : ''
                        }
                    </td>
                </tr>
            `;
        }

        async function searchUser() {
    const email = document.getElementById('userSearchEmail').value.trim();
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    const usersResult = await window.dbHelpers.getAllUsers();
    if (!usersResult.success) {
        alert('Failed to search users');
        return;
    }
    
    const user = usersResult.data.find(u => u.email.toLowerCase() === email.toLowerCase());
    if (!user) {
        alert('User not found');
        document.getElementById('userManagementResult').classList.add('hidden');
        return;
    }
    
    if (user.is_admin) {
        alert('Cannot manage admin users');
        document.getElementById('userManagementResult').classList.add('hidden');
        return;
    }
    
    // Display user details
    const userDetails = document.getElementById('userDetails');
    userDetails.innerHTML = `
        <h5 class="font-semibold text-gray-900 mb-2">User: ${user.email}</h5>
        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
            <p>Type: <span class="font-medium">${user.user_type}</span></p>
            <p>Credits: <span class="font-medium">${user.credits}</span></p>
            <p>Access Expiry: <span class="font-medium">${user.access_expiry ? new Date(user.access_expiry).toLocaleDateString() : 'None'}</span></p>
            <p>Created: <span class="font-medium">${formatDate(user.created_at)}</span></p>
        </div>
    `;
    
    // Store user ID for operations
    document.getElementById('userManagementResult').dataset.userId = user.id;
    document.getElementById('userManagementResult').classList.remove('hidden');
}

async function updateUserCredits() {
    const userId = document.getElementById('userManagementResult').dataset.userId;
    const credits = parseInt(document.getElementById('setCredits').value);
    
    if (!userId) {
        alert('Please search for a user first');
        return;
    }
    
    if (isNaN(credits) || credits < 0) {
        alert('Please enter a valid number of credits (0 or higher)');
        return;
    }
    
    try {
        // Update user to credits type and set credits
        const updateResult = await window.supabase
            .from('user_profiles')
            .update({
                user_type: 'credits',
                credits: credits,
                access_expiry: null
            })
            .eq('id', userId)
            .select()
            .single();
        
        if (!updateResult.error) {
            alert(`Credits set successfully to ${credits}. User converted to credits type.`);
            // Refresh the search to show updated info
            document.getElementById('searchUserBtn').click();
            document.getElementById('setCredits').value = '';
        } else {
            alert('Failed to update credits: ' + updateResult.error.message);
        }
    } catch (error) {
        alert('Failed to update credits: ' + error.message);
    }
}

async function setUserTime() {
    const userId = document.getElementById('userManagementResult').dataset.userId;
    const monthsToSet = parseInt(document.getElementById('setMonths').value);
    
    if (!userId) {
        alert('Please search for a user first');
        return;
    }
    
    if (isNaN(monthsToSet) || monthsToSet < 0) {
        alert('Please enter a valid number of months (0 or higher)');
        return;
    }
    
    try {
        let updateData = {};
        
        if (monthsToSet === 0) {
            // Convert to credits user with 0 credits
            updateData = {
                user_type: 'credits',
                credits: 0,
                access_expiry: null
            };
        } else {
            // Calculate new expiry date from now
            const now = new Date();
            const newExpiry = new Date(now);
            newExpiry.setMonth(newExpiry.getMonth() + monthsToSet);
            
            updateData = {
                user_type: 'student',
                access_expiry: newExpiry.toISOString()
            };
        }
        
        const updateResult = await window.supabase
            .from('user_profiles')
            .update(updateData)
            .eq('id', userId)
            .select()
            .single();
        
        if (!updateResult.error) {
            if (monthsToSet === 0) {
                alert('User converted to credits type with 0 credits');
            } else {
                const newExpiry = new Date();
                newExpiry.setMonth(newExpiry.getMonth() + monthsToSet);
                alert(`Successfully set ${monthsToSet} months. User is now a student until ${newExpiry.toLocaleDateString()}`);
            }
            // Refresh the search to show updated info
            document.getElementById('searchUserBtn').click();
            document.getElementById('setMonths').value = '';
        } else {
            alert('Failed to set time: ' + updateResult.error.message);
        }
    } catch (error) {
        alert('Failed to set time: ' + error.message);
    }
}
        
        function closeUserManagement() {
            const modal = document.getElementById('userManagementModal');
            if (modal) {
                modal.remove();
            }
        }

        async function suspendUser(userId) {
            if (!confirm('Are you sure you want to suspend this user? They will not be able to log in.')) {
                return;
            }
            
            const result = await window.dbHelpers.updateUserStatus(userId, 'suspended');
            if (result.success) {
                // Refresh the user table
                const tableBody = document.getElementById('userTableBody');
                if (tableBody) {
                    const usersResult = await window.dbHelpers.getAllUsers();
                    if (usersResult.success) {
                        const users = usersResult.data.filter(u => !u.is_admin);
                        tableBody.innerHTML = users.map(user => createUserRow(user)).join('');
                    }
                }
                alert('User suspended successfully.');
            } else {
                alert('Failed to suspend user: ' + result.error);
            }
        }

        async function unsuspendUser(userId) {
            if (!confirm('Are you sure you want to unsuspend this user?')) {
                return;
            }
            
            const result = await window.dbHelpers.updateUserStatus(userId, 'active');
            if (result.success) {
                // Refresh the user table
                const tableBody = document.getElementById('userTableBody');
                if (tableBody) {
                    const usersResult = await window.dbHelpers.getAllUsers();
                    if (usersResult.success) {
                        const users = usersResult.data.filter(u => !u.is_admin);
                        tableBody.innerHTML = users.map(user => createUserRow(user)).join('');
                    }
                }
                alert('User unsuspended successfully.');
            } else {
                alert('Failed to unsuspend user: ' + result.error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            const result = await window.dbHelpers.updateUserStatus(userId, 'deleted');
            if (result.success) {
                // Refresh the user table
                const tableBody = document.getElementById('userTableBody');
                if (tableBody) {
                    const usersResult = await window.dbHelpers.getAllUsers();
                    if (usersResult.success) {
                        const users = usersResult.data.filter(u => !u.is_admin);
                        tableBody.innerHTML = users.map(user => createUserRow(user)).join('');
                    }
                }
                alert('User deleted successfully.');
            } else {
                alert('Failed to delete user: ' + result.error);
            }
        }

        function viewHistoryItem(submissionId) {
            // Find the submission from current loaded data or fetch it
            // For now, we'll implement a simple version that sets currentEvaluation
            // In a more robust implementation, you'd fetch the specific submission
            
            // This is a simplified implementation - in practice you'd want to fetch the submission by ID
            showSection('results');
        }

        async function downloadHistoryPDF(submissionId) {
            try {
                // Fetch the specific submission
                const submissionsResult = await window.dbHelpers.getUserSubmissions(currentUser.id);
                if (submissionsResult.success) {
                    const submission = submissionsResult.data.find(s => s.id === submissionId);
                    if (submission) {
                        // Temporarily set as current evaluation for PDF generation
                        const originalEvaluation = currentEvaluation;
                        currentEvaluation = submission;
                        
                        // Generate PDF
                        downloadEvaluationPDF();
                        
                        // Restore original evaluation
                        currentEvaluation = originalEvaluation;
                    } else {
                        alert('Evaluation not found');
                    }
                } else {
                    alert('Failed to load evaluation');
                }
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF');
            }
        }

        async function deleteHistoryItem(submissionId) {
            if (!confirm('Are you sure you want to delete this evaluation? This action cannot be undone.')) {
                return;
            }
            
            const result = await window.dbHelpers.deleteSubmission(submissionId);
            if (result.success) {
                loadHistory(); // Refresh the history display
                if (currentUserProfile.is_admin) {
                    updateAdminSection(); // Update admin counts if admin
                }
                alert('Evaluation deleted successfully');
            } else {
                alert('Failed to delete evaluation: ' + result.error);
            }
        }

        function updateHistoryPagination(totalPages) {
            const paginationHTML = [];
            
            // Previous button
            if (currentHistoryPage > 1) {
                paginationHTML.push(`
                    <button onclick="changeHistoryPage(${currentHistoryPage - 1})" 
                            class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        Previous
                    </button>
                `);
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const isActive = i === currentHistoryPage;
                paginationHTML.push(`
                    <button onclick="changeHistoryPage(${i})" 
                            class="px-3 py-1 ${isActive ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'} rounded hover:${isActive ? 'bg-red-700' : 'bg-gray-300'}">
                        ${i}
                    </button>
                `);
            }
            
            // Next button
            if (currentHistoryPage < totalPages) {
                paginationHTML.push(`
                    <button onclick="changeHistoryPage(${currentHistoryPage + 1})" 
                            class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        Next
                    </button>
                `);
            }
            
            document.getElementById('historyPagination').innerHTML = paginationHTML.join('');
        }

        function changeHistoryPage(page) {
            currentHistoryPage = page;
            loadHistory();
        }

        // Student code redemption on payment page
        async function redeemStudentCode() {
            const codeInput = document.getElementById('paymentPageStudentCode');
            const redeemButton = document.getElementById('redeemCodeBtn');
            const resultDiv = document.getElementById('codeRedemptionResult');
            
            const studentCode = codeInput.value.trim();
            
            if (!studentCode) {
                showCodeResult('Please enter a student code', 'error');
                return;
            }
            
            // Show loading state
            redeemButton.disabled = true;
            redeemButton.textContent = 'Redeeming...';
            
            try {
                // Validate the code
                const codeResult = await window.dbHelpers.getStudentCode(studentCode);
                
                if (!codeResult.success) {
                    showCodeResult('Invalid or already used student code', 'error');
                    return;
                }
                
                const validatedCode = codeResult.data;
                
                // Process the code based on type
                if (validatedCode.code_type === 'credit_based') {
                    // Add credits to current user
                    const newCredits = currentUserProfile.credits + validatedCode.credits;
                    const updateResult = await window.dbHelpers.updateUserCredits(currentUser.id, newCredits);
                    
                    if (updateResult.success) {
                        // Mark code as used
                        await window.dbHelpers.useStudentCode(studentCode, currentUser.id);
                        
                        // Update local profile
                        currentUserProfile.credits = newCredits;
                        updateUI();
                        
                        showCodeResult(`Success! ${validatedCode.credits} credits added to your account.`, 'success');
                        codeInput.value = '';
                        
                        // If user now has credits, redirect to logline page
                        setTimeout(() => {
                            showSection('logline');
                        }, 2000);
                    } else {
                        showCodeResult('Failed to add credits. Please try again.', 'error');
                    }
                    
                } else {
                    // Time-based code - convert user to student
                    const expiry = new Date();
                    expiry.setMonth(expiry.getMonth() + validatedCode.months);
                    
                    const updateResult = await window.supabase
                        .from('user_profiles')
                        .update({
                            user_type: 'student',
                            access_expiry: expiry.toISOString()
                        })
                        .eq('id', currentUser.id)
                        .select()
                        .single();
                    
                    if (!updateResult.error) {
                        // Mark code as used
                        await window.dbHelpers.useStudentCode(studentCode, currentUser.id);
                        
                        // Update local profile
                        currentUserProfile = updateResult.data;
                        updateUI();
                        
                        showCodeResult(`Success! You now have ${validatedCode.months} months of unlimited access.`, 'success');
                        codeInput.value = '';
                        
                        // Redirect to logline page
                        setTimeout(() => {
                            showSection('logline');
                        }, 2000);
                    } else {
                        showCodeResult('Failed to activate student access. Please try again.', 'error');
                    }
                }
                
            } catch (error) {
                console.error('Code redemption error:', error);
                showCodeResult('An error occurred. Please try again.', 'error');
            } finally {
                redeemButton.disabled = false;
                redeemButton.textContent = 'Redeem Code';
            }
        }
        
        function showCodeResult(message, type) {
            const resultDiv = document.getElementById('codeRedemptionResult');
            resultDiv.className = `mt-3 p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}`;
            resultDiv.textContent = message;
            resultDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds for errors
            if (type === 'error') {
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 5000);
            }
        }
        // Form data persistence functions
        function clearLoglineForm() {
            document.getElementById('genre').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('mainCharacter').value = '';
            document.getElementById('antagonist').value = '';
            document.getElementById('incitingIncident').value = '';
            document.getElementById('storyDetails').value = '';
            document.getElementById('logline').value = '';
        }

        function saveCurrentFormData() {
            if (!currentUser) return;
            
            const formData = {
                genre: document.getElementById('genre').value,
                tone: document.getElementById('tone').value,
                mainCharacter: document.getElementById('mainCharacter').value,
                antagonist: document.getElementById('antagonist').value,
                incitingIncident: document.getElementById('incitingIncident').value,
                storyDetails: document.getElementById('storyDetails').value,
                logline: document.getElementById('logline').value
            };
            
            localStorage.setItem(`formData_${currentUser.id}`, JSON.stringify(formData));
        }

        function loadUserFormData() {
            if (!currentUser) return;
            
            try {
                const savedData = localStorage.getItem(`formData_${currentUser.id}`);
                if (savedData) {
                    const formData = JSON.parse(savedData);
                    document.getElementById('genre').value = formData.genre || '';
                    document.getElementById('tone').value = formData.tone || '';
                    document.getElementById('mainCharacter').value = formData.mainCharacter || '';
                    document.getElementById('antagonist').value = formData.antagonist || '';
                    document.getElementById('incitingIncident').value = formData.incitingIncident || '';
                    document.getElementById('storyDetails').value = formData.storyDetails || '';
                    document.getElementById('logline').value = formData.logline || '';
                }
            } catch (error) {
                console.error('Error loading form data:', error);
            }
        }

        async function loadLastSubmissionData() {
            if (!currentUser) return;
            
            try {
                const submissionsResult = await window.dbHelpers.getUserSubmissions(currentUser.id);
                if (submissionsResult.success && submissionsResult.data.length > 0) {
                    // Get the most recent submission
                    const lastSubmission = submissionsResult.data[0];
                    const formData = lastSubmission.form_data;
                    
                    document.getElementById('genre').value = formData.genre || '';
                    document.getElementById('tone').value = formData.tone || '';
                    document.getElementById('mainCharacter').value = formData.mainCharacter || '';
                    document.getElementById('antagonist').value = formData.antagonist || '';
                    document.getElementById('incitingIncident').value = formData.incitingIncident || '';
                    document.getElementById('storyDetails').value = formData.storyDetails || '';
                    document.getElementById('logline').value = formData.logline || '';
                    
                    // Save this as current form data
                    saveCurrentFormData();
                }
            } catch (error) {
                console.error('Error loading last submission:', error);
            }
        }

        // Footer navigation functions
        function showGettingStarted() {
            // Create Getting Started modal
            document.body.insertAdjacentHTML('beforeend', `
                <div id="gettingStartedModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-8 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Getting Started with the Logline Evaluator</h2>
                                <button onclick="closeModal('gettingStartedModal')" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="prose max-w-none">
                                <h3>Welcome to the BRS Labs Logline Evaluator!</h3>
                                <p>This tool helps you craft compelling loglines that grab Hollywood's attention. Here's how to get the most out of it:</p>
                                
                                <h4>Tips for Better Results:</h4>
                                <ul>
                                    <li><strong>Be specific:</strong> The more detail you provide in each field, the better your evaluation will be</li>
                                    <li><strong>Focus on conflict:</strong> Clearly describe what your protagonist wants and what's stopping them</li>
                                    <li><strong>Show the stakes:</strong> What happens if your protagonist fails?</li>
                                    <li><strong>Include unique elements:</strong> What makes your story different from others in the genre?</li>
                                </ul>
                                
                                <h4>How It Works:</h4>
                                <ol>
                                    <li>Fill out all the form fields with information about your story</li>
                                    <li>Enter your current logline</li>
                                    <li>Click "Get My Evaluation" to receive detailed feedback</li>
                                    <li>Review the suggestions and download your results as a PDF</li>
                                    <li>Refine your logline and run it through again for even better results</li>
                                </ol>
                                
                                <h4>Need Help?</h4>
                                 <p>Check out our <a href="#" onclick="closeModal('gettingStartedModal'); showFAQ();" class="text-blue-600 hover:text-blue-800 underline">FAQs</a> or contact us at <a href="mailto:support@bigredstripe.com" class="text-blue-600 hover:text-blue-800 underline">support@bigredstripe.com</a></p>
                              </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function showFAQ() {
            document.body.insertAdjacentHTML('beforeend', `
                <div id="faqModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-8 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Frequently Asked Questions</h2>
                                <button onclick="closeModal('faqModal')" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">How does the credit system work?</h3>
                                    <p class="text-gray-700">Each evaluation uses one credit. Credits never expire, so you can use them whenever you're ready. You can purchase more credits anytime from the Purchase page.</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Can I get a refund?</h3>
                                    <p class="text-gray-700">Yes! We offer refunds based on usage: 100% refund if no evaluations used, 50% refund for 1-5 evaluations, no refund for 6+ evaluations. Requests must be made within 30 days of purchase.</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">What makes a good logline?</h3>
                                    <p class="text-gray-700">A strong logline is concise (1-2 sentences), includes your protagonist, the central conflict, and the stakes. It should give a clear sense of genre and make the reader want to know what happens next.</p>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Need More Help?</h3>
                                    <p class="text-gray-700">For additional questions or technical support, please contact us at <a href="mailto:support@bigredstripe.com" class="text-blue-600 hover:text-blue-800">support@bigredstripe.com</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function showPrivacyPolicy() {
            document.body.insertAdjacentHTML('beforeend', `
                <div id="privacyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-8 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Privacy Policy</h2>
                                <button onclick="closeModal('privacyModal')" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="prose max-w-none text-sm">
                                <p><strong>Effective Date:</strong> [Date]</p>
                                <p><strong>Last Updated:</strong> [Date]</p>
                                
                                <h3>1. Information We Collect</h3>
                                <p>We collect information you provide directly to us, including:</p>
                                <ul>
                                    <li>Account information (email address, password)</li>
                                    <li>Form submissions (loglines, story details, genre information)</li>
                                    <li>Payment information (processed securely through Stripe)</li>
                                    <li>Usage analytics and login information</li>
                                </ul>
                                
                                <h3>2. How We Use Your Information</h3>
                                <p>We use the information we collect to:</p>
                                <ul>
                                    <li>Provide and improve our logline evaluation service</li>
                                    <li>Process payments and manage your account</li>
                                    <li>Send service-related communications</li>
                                    <li>Analyze usage patterns to improve our service</li>
                                </ul>
                                
                                <h3>3. Information Sharing</h3>
                                <p>We share your information with third-party service providers:</p>
                                <ul>
                                    <li>Supabase (database hosting)</li>
                                    <li>Stripe (payment processing)</li>
                                    <li>Anthropic (AI evaluation service)</li>
                                    <li>EmailJS (email communications)</li>
                                    <li>Netlify (web hosting)</li>
                                </ul>
                                
                                <h3>4. Data Security</h3>
                                <p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>
                                
                                <h3>5. Data Retention</h3>
                                <p>We retain your information indefinitely until you request account deletion. You may request deletion of your account and data by contacting us.</p>
                                
                                <h3>6. Contact Us</h3>
                                <p>If you have questions about this Privacy Policy, please contact us at:</p>
                                <p>BRS Labs, LLC<br>
                                5627 Kanan Rd., Ste. 280<br>
                                Agoura Hills, CA 91301<br>
                                Email: support@bigredstripe.com</p>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function showTermsOfService() {
            document.body.insertAdjacentHTML('beforeend', `
                <div id="termsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-8 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Terms of Service</h2>
                                <button onclick="closeModal('termsModal')" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="prose max-w-none text-sm">
                                <p><strong>Effective Date:</strong> [Date]</p>
                                <p><strong>Last Updated:</strong> [Date]</p>
                                
                                <h3>1. Acceptance of Terms</h3>
                                <p>By accessing and using the BRS Labs Logline Evaluator service, you accept and agree to be bound by these Terms of Service.</p>
                                
                                <h3>2. Description of Service</h3>
                                <p>BRS Labs provides an AI-powered logline evaluation service that analyzes and provides feedback on screenplay loglines.</p>
                                
                                <h3>3. User Accounts</h3>
                                <p>You are responsible for maintaining the confidentiality of your account and password. You agree to accept responsibility for all activities under your account.</p>
                                
                                <h3>4. Payment Terms</h3>
                                <p>Credits are required to use the evaluation service. Credits never expire. Payment is processed securely through Stripe. All sales are final subject to our refund policy.</p>
                                
                                <h3>5. Acceptable Use</h3>
                                <p>You agree not to:</p>
                                <ul>
                                    <li>Use the service for any unlawful purpose</li>
                                    <li>Attempt to gain unauthorized access to the service</li>
                                    <li>Submit content that is offensive, defamatory, or infringes intellectual property rights</li>
                                    <li>Attempt to reverse engineer or copy the service</li>
                                </ul>
                                
                                <h3>6. Intellectual Property</h3>
                                <p>You retain ownership of your submitted content. BRS Labs retains all rights to the service and evaluation technology.</p>
                                
                                <h3>7. Limitation of Liability</h3>
                                <p>BRS Labs shall not be liable for any indirect, incidental, special, or consequential damages resulting from your use of the service.</p>
                                
                                <h3>8. Governing Law</h3>
                                <p>These terms are governed by the laws of the State of California, United States.</p>
                                
                                <h3>9. Contact Information</h3>
                                <p>BRS Labs, LLC<br>
                                5627 Kanan Rd., Ste. 280<br>
                                Agoura Hills, CA 91301<br>
                                Email: support@bigredstripe.com</p>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function showRefundPolicy() {
            document.body.insertAdjacentHTML('beforeend', `
                <div id="refundModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-8 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">Refund Policy</h2>
                                <button onclick="closeModal('refundModal')" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="prose max-w-none">
                                <p><strong>Effective Date:</strong> [Date]</p>
                                <p><strong>Last Updated:</strong> [Date]</p>
                                
                                <h3>Refund Eligibility</h3>
                                <p>We offer refunds based on your usage of the evaluation service:</p>
                                
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                    <h4 class="text-green-800 font-semibold">100% Refund</h4>
                                    <p class="text-green-700 mb-0">Available if no evaluations have been completed</p>
                                </div>
                                
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                    <h4 class="text-yellow-800 font-semibold">50% Refund</h4>
                                    <p class="text-yellow-700 mb-0">Available if 1-5 evaluations have been completed</p>
                                </div>
                                
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                    <h4 class="text-red-800 font-semibold">No Refund</h4>
                                    <p class="text-red-700 mb-0">If 6 or more evaluations have been completed</p>
                                </div>
                                
                                <h3>Important Conditions</h3>
                                <ul>
                                    <li><strong>Time Limit:</strong> Refund requests must be made within 30 days of credit purchase</li>
                                    <li><strong>Refund Amount:</strong> Based on evaluations used, regardless of remaining credits</li>
                                    <li><strong>Terms Violations:</strong> No refunds available if Terms of Service are violated</li>
                                    <li><strong>Request Method:</strong> Written request required from the account email address</li>
                                </ul>
                                
                                <h3>How to Request a Refund</h3>
                                <p>To request a refund, send an email to <a href="mailto:support@bigredstripe.com">support@bigredstripe.com</a> from your account email address. Include:</p>
                                <ul>
                                    <li>Your account email address</li>
                                    <li>Date of purchase</li>
                                    <li>Reason for refund request</li>
                                </ul>
                                
                                <p>Refunds are processed within 5-10 business days to your original payment method.</p>
                                
                                <h3>Contact Us</h3>
                                <p>Questions about our refund policy? Contact us at support@bigredstripe.com</p>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }
      // Auto-show Getting Started for new users (only once)
        function checkAndShowGettingStarted() {
            if (!currentUser || !currentUserProfile) return;
            
            // Check if they've already seen the Getting Started modal
            const hasSeenGettingStarted = localStorage.getItem(`gettingStarted_${currentUser.id}`);
            if (hasSeenGettingStarted) return;
            
            // Check if this is their first time (no submissions yet)
            window.dbHelpers.getUserSubmissions(currentUser.id).then(result => {
                if (result.success && result.data.length === 0) {
                    // New user with no submissions - show Getting Started
                    setTimeout(() => {
                        showGettingStarted();
                        // Mark as seen
                        localStorage.setItem(`gettingStarted_${currentUser.id}`, 'true');
                    }, 1000);
                }
            });
        }
   </script>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white mt-auto">
        <div class="max-w-6xl mx-auto px-6 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Column 1: Help & Support -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Help & Support</h3>
                    <ul class="space-y-2">
                        <li><a href="#" onclick="showGettingStarted()" class="text-gray-300 hover:text-white transition-colors">Getting Started</a></li>
                        <li><a href="#" onclick="showFAQ()" class="text-gray-300 hover:text-white transition-colors">FAQs</a></li>
                        <li><a href="mailto:support@bigredstripe.com" class="text-gray-300 hover:text-white transition-colors">Contact BRS Labs</a></li>
                    </ul>
                </div>
                
                <!-- Column 2: Resources & Learning -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Resources & Learning</h3>
                    <ul class="space-y-2">
                       <li><a href="https://sales.bigredstripe.com/crucible/?website=LoglineEval_Footer" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors">The Crucible</a></li>
                        <li><a href="https://learn.bigredstripe.com/courses/the-complete-guide-to-story-structure?website=LoglineEval_Footer" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors">The Complete Guide to Story Structure</a></li>
                        <li><a href="https://learn.bigredstripe.com/pages/brs-newsletter?website=LoglineEval_Footer" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors">Get Weekly Screenwriting Tips</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Bottom Section -->
            <div class="border-t border-gray-700 mt-6 pt-6 flex flex-col md:flex-row justify-between items-center">
                <div class="text-sm text-gray-400 mb-4 md:mb-0">
                    ¬© 2025 BRS Labs, LLC. All rights reserved.
                </div>
                <div class="flex space-x-4 text-sm">
                    <a href="#" onclick="showPrivacyPolicy()" class="text-gray-400 hover:text-white transition-colors">Privacy Policy</a>
                    <a href="#" onclick="showTermsOfService()" class="text-gray-400 hover:text-white transition-colors">Terms of Service</a>
                    <a href="#" onclick="showRefundPolicy()" class="text-gray-400 hover:text-white transition-colors">Refund Policy</a>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
