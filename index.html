<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRS Labs - Logline Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
  (function() {
    emailjs.init({
      publicKey: "7cimGrBdlHCn4gSDy",
    });
  })();
</script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: 'Montserrat', Verdana, sans-serif;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #d9042b;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .history-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f9fafb;
        }
        .password-strength {
            height: 4px;
            border-radius: 2px;
            margin-top: 4px;
        }
        .password-weak { background-color: #ef4444; }
        .password-medium { background-color: #f59e0b; }
        .password-strong { background-color: #10b981; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Authentication Section -->
    <div id="authSection" class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="mx-auto h-12 w-auto flex justify-center">
                    <img src="logo.png" alt="BRS Labs" style="height: auto; width: auto; max-height: 48px; max-width: 200px;">
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Logline Evaluator
                </h2>
                <p id="authSubtitle" class="mt-2 text-center text-sm text-gray-600">
                    Sign in to your account
                </p>
            </div>

            <div class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <input type="email" id="authEmail" placeholder="Email address" required
                               class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div class="relative">
                        <input type="password" id="authPassword" placeholder="Password" required
                               class="relative block w-full px-3 py-2 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <span id="eyeIcon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    
                    <div id="registerFields" class="hidden space-y-4">
                        <div>
                            <input type="password" id="confirmPassword" placeholder="Confirm password" required
                                   class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <div id="passwordStrength" class="password-strength hidden"></div>
                            <div id="passwordRequirements" class="text-xs text-gray-500 mt-1 hidden">
                                Password must have: 8+ characters, uppercase, lowercase, number, special character
                            </div>
                        </div>
                        <div>
                            <input type="text" id="studentCode" placeholder="Student code (optional)"
                                   class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <p class="text-xs text-gray-500 mt-1">Have a student code? Enter it for 3 months free access!</p>
                        </div>
                    </div>
                </div>

                <div>
                    <button id="authSubmit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2"
                            style="background-color: #d9042b;">
                        <span id="authButtonText">Sign In</span>
                        <span id="authSpinner" class="hidden spinner ml-2"></span>
                    </button>
                </div>

                <div class="text-center space-y-2">
                    <button id="authToggle" class="text-red-600 hover:text-red-500 text-sm">
                        Don't have an account? Sign up
                    </button>
                    <div>
                        <button id="forgotPasswordBtn" class="text-gray-600 hover:text-gray-500 text-sm">
                            Forgot your password?
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="resetModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Reset Password</h3>
                <input type="email" id="resetEmail" placeholder="Enter your email address"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                <div class="mt-4 flex space-x-2">
                    <button id="sendResetBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                            style="background-color: #d9042b;">
                        Send Reset Link
                    </button>
                    <button id="cancelResetBtn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="logo.png" alt="BRS Labs" style="height: auto; width: auto; max-height: 32px; max-width: 150px;">
                    <h1 class="text-xl font-bold text-black">Logline Evaluator</h1>
                </div>

                <div class="flex items-center space-x-6">
                    <div id="userStatus" class="text-sm font-medium"></div>
                    <button id="loglineBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">Logline</button>
                    <button id="historyBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">History</button>
                    <button id="settingsBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">Settings</button>
                    <button id="logoutBtn" class="text-gray-600 hover:text-gray-800 text-sm font-medium">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <!-- Logline Form -->
            <div id="loglineSection" class="max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-black mb-4">Get Logline Feedback</h2>
                        <p class="text-gray-600 text-lg">
                            Submit information in each of the fields. The more information you include, the better your results. You will get feedback on your logline, five improved alternatives, and some possible title suggestions.
                        </p>
                    </div>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="genre" class="block text-sm font-semibold text-black mb-2">Genre</label>
                                <input type="text" id="genre" placeholder="e.g., Psychological Thriller, Romantic Comedy" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="tone" class="block text-sm font-semibold text-black mb-2">Tone</label>
                                <input type="text" id="tone" placeholder="e.g., gritty, comedic, uplifting, psychological" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                            </div>
                        </div>

                        <div>
                            <label for="mainCharacter" class="block text-sm font-semibold text-black mb-2">Protagonist (broad strokes)</label>
                            <textarea id="mainCharacter" placeholder="Who they are and what makes them unique or compelling" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="antagonist" class="block text-sm font-semibold text-black mb-2">Antagonist / Antagonistic Force (broad strokes)</label>
                            <textarea id="antagonist" placeholder="The person, group, or environmental factor along with what they want" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="incitingIncident" class="block text-sm font-semibold text-black mb-2">Setup or Inciting Incident Summary</label>
                            <textarea id="incitingIncident" placeholder="What kicks off the story" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="storyDetails" class="block text-sm font-semibold text-black mb-2">1-2 Interesting Details About the Story</label>
                            <textarea id="storyDetails" placeholder="Any elements unique to the world of the story" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <div>
                            <label for="logline" class="block text-sm font-semibold text-black mb-2">Your Logline</label>
                            <textarea id="logline" placeholder="Enter your current logline here" rows="4"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required></textarea>
                        </div>

                        <button id="evaluateBtn" type="button" class="w-full font-semibold py-4 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2"
                                style="background-color: #d9042b; color: white;">
                            <span id="evaluateText">Get My Evaluation</span>
                            <span id="evaluateSpinner" class="hidden spinner"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-black">Your Logline Evaluation</h2>
                        <div class="flex space-x-2">
                            <button id="downloadPdfBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                Download PDF
                            </button>
                            <button id="resetBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg transition-colors">
                                Evaluate Another Logline
                            </button>
                        </div>
                    </div>

                    <div class="prose prose-lg max-w-none">
                        <div class="bg-gray-50 p-6 rounded-lg mb-6">
                            <h3 class="text-lg font-semibold text-black mb-2">Your Original Logline:</h3>
                            <p id="originalLogline" class="text-gray-800 italic"></p>
                        </div>

                        <div id="evaluationResult" class="whitespace-pre-wrap text-gray-800 leading-relaxed"></div>
                        
                        <hr class="my-8 border-gray-300">
                        
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <p class="text-gray-700 text-base leading-relaxed">
                                The Logline Evaluator is meant to help you hone and craft your logline. For better results, consider choosing one of the suggestions or a combination of the suggestions, and running that new logline through the evaluator.
                            </p>
                        </div>
                        
                        <hr class="my-6 border-gray-300">
                        
                        <div class="text-center">
                            <p class="text-gray-700">
                                If you want to learn how to write Hollywood-quality screenplays, <a href="https://sales.bigredstripe.com/crucible/?video=LoglineEvaluatorLink" target="_blank" rel="noopener noreferrer" class="text-red-600 hover:text-red-800 underline">click here</a>.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="historySection" class="hidden max-w-6xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-black">Your Evaluation History</h2>
                        <button id="showAllHistoryBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg transition-colors">
                            Show All
                        </button>
                    </div>

                    <div id="historyList" class="space-y-4">
                        <!-- History items will be inserted here -->
                    </div>

                    <div id="historyPagination" class="flex justify-center space-x-2 mt-6">
                        <!-- Pagination buttons will be inserted here -->
                    </div>

                    <div id="noHistory" class="hidden text-center py-12">
                        <p class="text-gray-500 text-lg">No evaluations yet. <a href="#" onclick="showSection('logline')" class="text-red-600 hover:text-red-800 underline">Create your first evaluation!</a></p>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="hidden max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-black mb-8">Account Settings</h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Account Information -->
                        <div class="space-y-6">
                            <h3 class="text-xl font-semibold text-black">Account Information</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                <div class="flex space-x-2">
                                    <input type="email" id="newEmail" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    <button id="updateEmailBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700" style="background-color: #d9042b;">
                                        Update
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <h4 class="text-lg font-medium text-gray-900">Change Password</h4>
                                <div>
                                    <input type="password" id="currentPassword" placeholder="Current password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                </div>
                                <div>
                                    <input type="password" id="newPassword" placeholder="New password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    <div id="newPasswordStrength" class="password-strength hidden"></div>
                                </div>
                                <div>
                                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                </div>
                                <button id="updatePasswordBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700" style="background-color: #d9042b;">
                                    Update Password
                                </button>
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="space-y-6">
                            <h3 class="text-xl font-semibold text-black">Payment Information</h3>
                            
                            <div id="creditUserPayment" class="hidden">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <p class="text-sm text-gray-600 mb-2">Current Credits: <span id="currentCredits" class="font-semibold"></span></p>
                                </div>
                                
                                <button id="managePaymentBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 mb-4">
                                    Manage Payment Methods
                                </button>
                                
                                <button id="buyMoreCreditsBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    Buy More Credits
                                </button>
                            </div>

                            <div id="studentUserPayment" class="hidden">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <p class="text-sm text-green-800">
                                        Student Access: <span id="studentDaysLeft" class="font-semibold"></span> days remaining
                                    </p>
                                </div>
                            </div>

                            <div id="adminUserPayment" class="hidden">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <p class="text-sm text-purple-800 font-semibold">Administrator - Unlimited Access</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Section -->
                    <div id="adminSettings" class="hidden mt-12 pt-8 border-t border-gray-200">
                        <h3 class="text-xl font-semibold text-black mb-6">Admin Functions</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Student Codes -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-medium text-gray-900">Generate Student Codes</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                        <input type="number" id="codeQuantity" min="1" value="1"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Months</label>
                                        <input type="number" id="codeMonths" min="1" value="3"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    </div>
                                </div>
                                <button id="generateCodesBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                                        style="background-color: #d9042b;">
                                    Generate Codes
                                </button>
                                <button id="downloadCodesBtn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg">
                                    Download Codes (<span id="codesCount">0</span>)
                                </button>
                            </div>

                            <!-- Analytics -->
                            <div class="space-y-4">
                                <h4 class="text-lg font-medium text-gray-900">Analytics</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-red-600" id="totalUsers">0</div>
                                        <div class="text-sm text-gray-600">Total Users</div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-red-600" id="totalEvaluations">0</div>
                                        <div class="text-sm text-gray-600">Total Evaluations</div>
                                    </div>
                                </div>
                                <button id="downloadAllSubmissionsBtn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg">
                                    Download All Submissions (<span id="submissionsCount">0</span>)
                                </button>
                                <button id="viewUsersBtn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-black rounded-lg mb-2">
                                    View All Users (<span id="userCount">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Section -->
            <div id="purchaseSection" class="hidden max-w-4xl mx-auto px-6 py-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-black mb-6">Purchase Credits</h2>
                    <p class="text-gray-600 mb-8">Choose a credit package to evaluate your loglines</p>

                    <div id="betaDiscount" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <h3 class="text-green-800 font-semibold">üéâ Beta Tester Discount!</h3>
                        <p class="text-green-700">Get 50% off your first purchase as an early supporter!</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="border border-gray-200 rounded-lg p-6 text-center">
                            <h3 class="text-xl font-bold mb-2">Starter Pack</h3>
                            <div class="text-3xl font-bold text-red-600 mb-2" id="price25">$30</div>
                            <div class="text-gray-600 mb-4">25 Evaluations</div>
                            <button onclick="purchaseCredits(25)" class="w-full py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                    style="background-color: #d9042b;">
                                Purchase
                            </button>
                        </div>

                        <div class="border-2 border-red-600 rounded-lg p-6 text-center relative">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-3 py-1 rounded-full text-sm">
                                Best Value
                            </div>
                            <h3 class="text-xl font-bold mb-2">Pro Pack</h3>
                            <div class="text-3xl font-bold text-red-600 mb-2" id="price50">$55</div>
                            <div class="text-gray-600 mb-4">50 Evaluations</div>
                            <button onclick="purchaseCredits(50)" class="w-full py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                    style="background-color: #d9042b;">
                                Purchase
                            </button>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-6 text-center">
                            <h3 class="text-xl font-bold mb-2">Writer Pack</h3>
                            <div class="text-3xl font-bold text-red-600 mb-2" id="price100">$100</div>
                            <div class="text-gray-600 mb-4">100 Evaluations</div>
                            <button onclick="purchaseCredits(100)" class="w-full py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                    style="background-color: #d9042b;">
                                Purchase
                            </button>
                        </div>
                    </div>

                    <div class="mt-8 text-center text-sm text-gray-500">
                        Credits never expire. Secure payment processing by Stripe.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS is in the Head
   
        // Initialize Stripe (you'll need to replace with your actual key)
     const stripe = Stripe('pk_test_51IAqQXGeynMWYbxDVS6wPalfpyuFfRknJN1xnYqmXGFT2B37foYZHdKYkMKohUZAgOOHflOGLYgiKev537GuOZKi00XO4MKDk9');

        // Global state
        let currentUser = null;
        let currentView = 'login';
        let isLoading = false;
        let currentHistoryPage = 1;
        let historyPerPage = 10;
        let showAllHistory = false;
       let currentEvaluation = null;

// Rate limiting for login attempts
let loginAttempts = {};
let passwordResetAttempts = {};

function isRateLimited(email, type) {
    const now = Date.now();
    const attempts = type === 'login' ? loginAttempts : passwordResetAttempts;
    
    if (!attempts[email]) {
        attempts[email] = { count: 0, lastAttempt: now };
    }
    
    const userAttempts = attempts[email];
    
    // Reset counter if more than 15 minutes have passed
    if (now - userAttempts.lastAttempt > 15 * 60 * 1000) {
        userAttempts.count = 0;
    }
    
    // Check if rate limited (max 5 attempts per 15 minutes)
    if (userAttempts.count >= 5) {
        const timeLeft = Math.ceil((userAttempts.lastAttempt + 15 * 60 * 1000 - now) / 1000 / 60);
        return { limited: true, timeLeft: timeLeft };
    }
    
    return { limited: false };
}

function recordAttempt(email, type, success) {
    const attempts = type === 'login' ? loginAttempts : passwordResetAttempts;
    
    if (!attempts[email]) {
        attempts[email] = { count: 0, lastAttempt: Date.now() };
    }
    
    if (success) {
        // Reset on successful attempt
        attempts[email].count = 0;
    } else {
        // Increment on failed attempt
        attempts[email].count++;
        attempts[email].lastAttempt = Date.now();
    }
}

// Mock database
let mockDB = {
            users: [{
                id: 'admin-001',
                email: 'jacob@bigredstripe.com',
                password: hashPassword('admin123'),
                userType: 'admin',
                credits: 999999,
                accessExpiry: null,
                createdAt: new Date().toISOString(),
                isAdmin: true
            }],
            submissions: [],
            studentCodes: []
        };

        // Utility Functions
        function hashPassword(password) {
            return btoa(password + 'salt123');
        }

        function checkPasswordStrength(password) {
            let strength = 0;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            strength = Object.values(requirements).filter(Boolean).length;
            
            if (strength < 3) return 'weak';
            if (strength < 5) return 'medium';
            return 'strong';
        }

        function updatePasswordStrength(passwordField, strengthElement) {
            const password = passwordField.value;
            const strength = checkPasswordStrength(password);
            
            strengthElement.className = 'password-strength password-' + strength;
            strengthElement.classList.remove('hidden');
        }

        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            return Object.values(requirements).every(Boolean);
        }

        function calculateDaysRemaining(expiryDate) {
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        function truncateLogline(logline, maxLength) {
            maxLength = maxLength || 50;
            if (logline.length <= maxLength) return logline;
            return logline.substring(0, maxLength) + '...';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

    // Initialize app
document.addEventListener('DOMContentLoaded', function() {
    // Check for password reset token in URL FIRST
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('reset');
    
    if (resetToken) {
        // Show password reset form instead of normal login
        showPasswordResetForm(resetToken);
        return; // Exit early, don't load normal app
    }

    document.addEventListener('DOMContentLoaded', function() {
    // Check for password reset token in URL FIRST
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('reset');
    
    if (resetToken) {
        // Show password reset form instead of normal login
        showPasswordResetForm(resetToken);
        return; // Exit early, don't load normal app
    }
    
    // Check for payment success
  //  const paymentSuccess = urlParams.get('payment');
  //  if (paymentSuccess === 'success') {
  //      const amount = urlParams.get('amount');
  //      const sessionId = urlParams.get('session_id');
  //      handlePaymentSuccess(amount, sessionId);
  //      return;
  //  }
    
    // Normal app initialization (existing code)
    const savedUser = localStorage.getItem('brs_user');
    const savedDB = localStorage.getItem('brs_db');
    
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
    }
    
    if (savedDB) {
        mockDB = JSON.parse(savedDB);
    } else {
        localStorage.setItem('brs_db', JSON.stringify(mockDB));
    }
    setupEventListeners();
    updateUI();
});

        function setupEventListeners() {
            // Auth listeners
            document.getElementById('authToggle').addEventListener('click', toggleAuthMode);
            document.getElementById('authSubmit').addEventListener('click', handleAuth);
            document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
            document.getElementById('forgotPasswordBtn').addEventListener('click', showPasswordReset);
            document.getElementById('sendResetBtn').addEventListener('click', sendPasswordReset);
            document.getElementById('cancelResetBtn').addEventListener('click', hidePasswordReset);
            
            // Navigation listeners
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('loglineBtn').addEventListener('click', function() { showSection('logline'); });
            document.getElementById('historyBtn').addEventListener('click', function() { showSection('history'); });
            document.getElementById('settingsBtn').addEventListener('click', function() { showSection('settings'); });
            
            // App listeners
            document.getElementById('evaluateBtn').addEventListener('click', evaluateLogline);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadEvaluationPDF);
            
            // History listeners
            document.getElementById('showAllHistoryBtn').addEventListener('click', toggleShowAllHistory);
            
            // Settings listeners
            document.getElementById('updateEmailBtn').addEventListener('click', updateEmail);
            document.getElementById('updatePasswordBtn').addEventListener('click', updatePassword);
            document.getElementById('managePaymentBtn').addEventListener('click', managePayment);
            document.getElementById('buyMoreCreditsBtn').addEventListener('click', function() { showSection('purchase'); });
            
            // Admin listeners
            document.getElementById('generateCodesBtn').addEventListener('click', generateStudentCodes);
            document.getElementById('downloadCodesBtn').addEventListener('click', downloadCodes);
            document.getElementById('downloadAllSubmissionsBtn').addEventListener('click', downloadAllSubmissions);
            document.getElementById('viewUsersBtn').addEventListener('click', viewAllUsers);  // ADD THIS LINE

            // Password strength listeners
            document.getElementById('authPassword').addEventListener('input', function() {
                if (currentView === 'register') {
                    updatePasswordStrength(this, document.getElementById('passwordStrength'));
                }
            });

            document.getElementById('newPassword').addEventListener('input', function() {
                updatePasswordStrength(this, document.getElementById('newPasswordStrength'));
            });
        }

        function saveToStorage() {
            localStorage.setItem('brs_user', JSON.stringify(currentUser));
            localStorage.setItem('brs_db', JSON.stringify(mockDB));
        }

        // Authentication Functions
        function toggleAuthMode() {
            currentView = currentView === 'login' ? 'register' : 'login';
            const registerFields = document.getElementById('registerFields');
            const subtitle = document.getElementById('authSubtitle');
            const buttonText = document.getElementById('authButtonText');
            const toggleText = document.getElementById('authToggle');
            const passwordRequirements = document.getElementById('passwordRequirements');

            if (currentView === 'register') {
                registerFields.classList.remove('hidden');
                passwordRequirements.classList.remove('hidden');
                subtitle.textContent = 'Create your account';
                buttonText.textContent = 'Create Account';
                toggleText.textContent = 'Already have an account? Sign in';
            } else {
                registerFields.classList.add('hidden');
                passwordRequirements.classList.add('hidden');
                subtitle.textContent = 'Sign in to your account';
                buttonText.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account? Sign up";
            }
        }

        function togglePasswordVisibility() {
            const passwordField = document.getElementById('authPassword');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.textContent = 'üôà';
            } else {
                passwordField.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
            }
        }

        function showPasswordReset() {
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function hidePasswordReset() {
            document.getElementById('resetModal').classList.add('hidden');
            document.getElementById('resetEmail').value = '';
        }

function showPasswordResetForm(token) {
    // Hide the normal page content
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('appSection').style.display = 'none';
    
    // Create password reset form
    document.body.innerHTML = `
        <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
            <div class="max-w-md w-full space-y-8">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="text-center mb-6">
                        <img src="logo.png" alt="BRS Labs" style="height: 48px; margin: 0 auto 20px;">
                        <h2 class="text-2xl font-bold text-gray-900">Reset Your Password</h2>
                        <p class="text-gray-600">Enter your new password below</p>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="password" id="newPasswordReset" placeholder="New password" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <input type="password" id="confirmPasswordReset" placeholder="Confirm new password" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-red-500 focus:border-red-500">
                        <button onclick="updatePasswordFromReset('${token}')" 
                                class="w-full py-3 px-4 bg-red-600 text-white font-medium rounded-md hover:bg-red-700"
                                style="background-color: #d9042b;">
                            Update Password
                        </button>
                        <div class="text-center">
                            <a href="${window.location.origin}" class="text-red-600 hover:text-red-500 text-sm">
                                Back to Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updatePasswordFromReset(token) {
    const newPassword = document.getElementById('newPasswordReset').value;
    const confirmPassword = document.getElementById('confirmPasswordReset').value;
    
    if (!newPassword || !confirmPassword) {
        alert('Please fill in both password fields');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
    }
    
    // Load the database
    const savedDB = localStorage.getItem('brs_db');
    if (savedDB) {
        mockDB = JSON.parse(savedDB);
    }
    
    // TODO: In real app, validate the reset token and find the specific user
    // For now, we'll find the user who requested the reset
    // Since we don't store token-to-user mapping, we'll need to prompt for email
    
    const userEmail = prompt('Please enter your email address to confirm the password reset:');
    if (!userEmail) {
        alert('Email address required to reset password');
        return;
    }
    
    // Find ANY user with that email and update password
    const user = mockDB.users.find(u => u.email === userEmail);
    if (user) {
        user.password = btoa(newPassword + 'salt123'); // Hash the new password
        localStorage.setItem('brs_db', JSON.stringify(mockDB)); // Save updated database
        alert('Password updated successfully! You can now login with your new password.');
    } else {
        alert('No account found with that email address');
        return;
    }
    
    window.location.href = window.location.origin;
}

     function viewAllUsers() {
    const users = mockDB.users.filter(function(u) { return !u.isAdmin; });
    
    if (users.length === 0) {
        alert('No users have registered yet.');
        return;
    }
    
    // Create user management modal instead of simple alert
    showUserManagementModal(users);
}

function showUserManagementModal(users) {
    // Create modal HTML
    const modalHTML = `
        <div id="userManagementModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-4/5 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-medium text-gray-900">User Management</h3>
                        <button onclick="closeUserManagementModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Email</th>
                                    <th class="px-4 py-2 text-left">Type</th>
                                    <th class="px-4 py-2 text-left">Credits/Days</th>
                                    <th class="px-4 py-2 text-left">Status</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr class="border-t">
                                        <td class="px-4 py-2">${user.email}</td>
                                        <td class="px-4 py-2">${user.userType}</td>
                                        <td class="px-4 py-2">
                                            ${user.userType === 'credits' ? user.credits + ' credits' : 
                                              (user.accessExpiry ? calculateDaysRemaining(user.accessExpiry) + ' days' : 'N/A')}
                                        </td>
                                        <td class="px-4 py-2">
                                            <span class="px-2 py-1 rounded text-xs ${user.suspended ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                ${user.suspended ? 'Suspended' : 'Active'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-2">
                                            <div class="flex space-x-2">
                                                ${user.suspended ? 
                                                    `<button onclick="unsuspendUser('${user.id}')" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Unsuspend</button>` :
                                                    `<button onclick="suspendUser('${user.id}')" class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Suspend</button>`
                                                }
                                                <button onclick="deleteUser('${user.id}')" class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeUserManagementModal() {
    const modal = document.getElementById('userManagementModal');
    if (modal) {
        modal.remove();
    }
}

function suspendUser(userId) {
    if (confirm('Are you sure you want to suspend this user? They will not be able to login.')) {
        const user = mockDB.users.find(u => u.id === userId);
        if (user) {
            user.suspended = true;
            saveToStorage();
            alert('User suspended successfully.');
            closeUserManagementModal();
            viewAllUsers(); // Refresh the list
        }
    }
}

function unsuspendUser(userId) {
    if (confirm('Are you sure you want to unsuspend this user?')) {
        const user = mockDB.users.find(u => u.id === userId);
        if (user) {
            user.suspended = false;
            saveToStorage();
            alert('User unsuspended successfully.');
            closeUserManagementModal();
            viewAllUsers(); // Refresh the list
        }
    }
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to PERMANENTLY DELETE this user? This cannot be undone.')) {
        if (confirm('This will permanently delete all user data. Are you absolutely sure?')) {
            // Remove user from database
            mockDB.users = mockDB.users.filter(u => u.id !== userId);
            // Remove user's submissions
            mockDB.submissions = mockDB.submissions.filter(s => s.userId !== userId);
            saveToStorage();
            updateAdminSection();
            alert('User deleted permanently.');
            closeUserManagementModal();
            viewAllUsers(); // Refresh the list
        }
    }
}
        
   async function sendPasswordReset() {
    const email = document.getElementById('resetEmail').value;
    if (!email) {
        alert('Please enter your email address');
        return;
    }
    
    // Check rate limiting
    const rateCheck = isRateLimited(email, 'reset');
    if (rateCheck.limited) {
        alert('Too many password reset attempts. Please try again in ' + rateCheck.timeLeft + ' minutes.');
        return;
    }

    const user = mockDB.users.find(function(u) { return u.email === email; });
    if (!user) {
        recordAttempt(email, 'reset', false);
        alert('No account found with that email address');
        return;
    }
    
    // Check if user is suspended
    if (user.suspended) {
        recordAttempt(email, 'reset', false);
        alert('Your account has been suspended. Please contact support for assistance.');
        return;
    }

    const resetToken = Math.random().toString(36).substr(2, 15);
    
    try {
        await emailjs.send('service_z3nppt7', 'template_40v3r7i', {
            to_email: email,
            email: email,
            reset_link: window.location.origin + '?reset=' + resetToken,
            user_name: email
        });

        recordAttempt(email, 'reset', true);
        alert('Password reset link sent to your email!');
        hidePasswordReset();
    } catch (error) {
        recordAttempt(email, 'reset', false);
        console.error('Email sending failed:', error);
        alert('Failed to send reset email. Please try again.');
    }
}

        async function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            if (!email || !password) {
                alert('Please fill in all required fields');
                return;
            }

            if (currentView === 'register') {
                const confirmPassword = document.getElementById('confirmPassword').value;
                const studentCode = document.getElementById('studentCode').value;

                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }

                if (!validatePassword(password)) {
                    alert('Password does not meet requirements');
                    return;
                }

                if (mockDB.users.find(function(u) { return u.email === email; })) {
                    alert('Email already exists');
                    return;
                }

                await register(email, password, studentCode);
            } else {
                await login(email, password);
            }
        }

      async function login(email, password) {
    // Check rate limiting first
    const rateCheck = isRateLimited(email, 'login');
    if (rateCheck.limited) {
        alert('Too many login attempts. Please try again in ' + rateCheck.timeLeft + ' minutes.');
        return;
    }
    
    setLoading(true);
    
    const hashedPassword = hashPassword(password);
    const user = mockDB.users.find(function(u) { 
        return u.email === email && u.password === hashedPassword; 
    });
    
    if (!user) {
        recordAttempt(email, 'login', false);
        alert('Invalid email or password');
        setLoading(false);
        return;
    }
    
    // Check if user is suspended
    if (user.suspended) {
        recordAttempt(email, 'login', false);
        alert('Your account has been suspended. Please contact support.');
        setLoading(false);
        return;
    }
    
    // Successful login
    recordAttempt(email, 'login', true);
    currentUser = user;
    saveToStorage();
    showApp();
    setLoading(false);
}

        async function register(email, password, studentCode) {
            setLoading(true);
            
            let userType = 'credits';
            let credits = 0;
            let accessExpiry = null;

            if (studentCode) {
                const code = mockDB.studentCodes.find(function(c) { 
                    return c.code === studentCode && !c.used; 
                });
                if (code) {
                    userType = 'student';
                    const expiry = new Date();
                    expiry.setMonth(expiry.getMonth() + code.months);
                    accessExpiry = expiry.toISOString();

                    code.used = true;
                    code.usedBy = email;
                    code.usedAt = new Date().toISOString();
                } else {
                    alert('Invalid or already used student code');
                    setLoading(false);
                    return;
                }
            }

            const newUser = {
                id: Date.now().toString(),
                email: email,
                password: hashPassword(password),
                userType: userType,
                credits: credits,
                accessExpiry: accessExpiry,
                createdAt: new Date().toISOString(),
                isAdmin: ['jacob@bigredstripe.com'].includes(email)
            };

            mockDB.users.push(newUser);
            currentUser = newUser;
            saveToStorage();
            showApp();
            setLoading(false);
        }

        function setLoading(loading) {
            isLoading = loading;
            const button = document.getElementById('authSubmit');
            const spinner = document.getElementById('authSpinner');
            
            button.disabled = loading;
            if (loading) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

      function showApp() {
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('appSection').classList.remove('hidden');
    
    // Force reset all admin sections when switching users
    document.getElementById('adminSettings').classList.add('hidden');
    document.getElementById('adminUserPayment').classList.add('hidden');
    
    showSection('logline');
    updateUI();
}

        function showSection(section) {
            document.getElementById('loglineSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('purchaseSection').classList.add('hidden');

            if (section === 'logline') {
                document.getElementById('loglineSection').classList.remove('hidden');
            } else if (section === 'history') {
                document.getElementById('historySection').classList.remove('hidden');
                loadHistory();
            } else if (section === 'settings') {
                document.getElementById('settingsSection').classList.remove('hidden');
                loadSettings();
            } else if (section === 'purchase') {
                document.getElementById('purchaseSection').classList.remove('hidden');
                updatePurchaseSection();
            } else if (section === 'results') {
                document.getElementById('resultsSection').classList.remove('hidden');
            }
        }

        function updateUI() {
            if (!currentUser) return;

            const userStatus = document.getElementById('userStatus');
            if (currentUser.userType === 'credits') {
                userStatus.textContent = currentUser.credits + ' credits remaining';
                userStatus.className = 'text-sm font-medium text-blue-600';
            } else if (currentUser.userType === 'student') {
                const daysLeft = calculateDaysRemaining(currentUser.accessExpiry);
                userStatus.textContent = daysLeft + ' days remaining';
                userStatus.className = 'text-sm font-medium text-green-600';
            } else if (currentUser.userType === 'admin') {
                userStatus.textContent = 'Unlimited access';
                userStatus.className = 'text-sm font-medium text-purple-600';
            }
        }

      function loadSettings() {
    document.getElementById('newEmail').value = currentUser.email;
    
    // Hide all payment sections first
    document.getElementById('creditUserPayment').classList.add('hidden');
    document.getElementById('studentUserPayment').classList.add('hidden');
    document.getElementById('adminUserPayment').classList.add('hidden');
    document.getElementById('adminSettings').classList.add('hidden'); // Always hide admin settings first
    
    if (currentUser.userType === 'credits') {
        document.getElementById('creditUserPayment').classList.remove('hidden');
        document.getElementById('currentCredits').textContent = currentUser.credits;
    } else if (currentUser.userType === 'student') {
        document.getElementById('studentUserPayment').classList.remove('hidden');
        const daysLeft = calculateDaysRemaining(currentUser.accessExpiry);
        document.getElementById('studentDaysLeft').textContent = daysLeft;
    }
    
    // Show admin sections ONLY if user is actually an admin
    if (currentUser.isAdmin === true) {
        document.getElementById('adminUserPayment').classList.remove('hidden');
        document.getElementById('adminSettings').classList.remove('hidden');
        updateAdminSection();
    }
}
        
        function updateAdminSection() {
            document.getElementById('totalUsers').textContent = mockDB.users.filter(function(u) { return !u.isAdmin; }).length;
            document.getElementById('totalEvaluations').textContent = mockDB.submissions.length;
            document.getElementById('codesCount').textContent = mockDB.studentCodes.length;
            document.getElementById('submissionsCount').textContent = mockDB.submissions.length;
            document.getElementById('userCount').textContent = mockDB.users.filter(function(u) { return !u.isAdmin; }).length;
        }

        // Core App Functions
        async function evaluateLogline() {
            const formData = {
                genre: document.getElementById('genre').value,
                tone: document.getElementById('tone').value,
                mainCharacter: document.getElementById('mainCharacter').value,
                antagonist: document.getElementById('antagonist').value,
                incitingIncident: document.getElementById('incitingIncident').value,
                storyDetails: document.getElementById('storyDetails').value,
                logline: document.getElementById('logline').value
            };

            if (!formData.genre || !formData.tone || !formData.mainCharacter || !formData.antagonist || !formData.incitingIncident || !formData.storyDetails || !formData.logline) {
                alert('Please fill in all fields before submitting.');
                return;
            }

            if (currentUser.userType === 'credits' && currentUser.credits <= 0) {
                alert('You have no credits remaining. Please purchase more credits to continue.');
                showSection('purchase');
                return;
            }

            if (currentUser.userType === 'student' && new Date(currentUser.accessExpiry) < new Date()) {
                alert('Your student access has expired. Please purchase credits to continue.');
                showSection('purchase');
                return;
            }

            const button = document.getElementById('evaluateBtn');
            const text = document.getElementById('evaluateText');
            const spinner = document.getElementById('evaluateSpinner');
            
            button.disabled = true;
            text.textContent = 'Evaluating Your Logline...';
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('/.netlify/functions/evaluate-logline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ formData: formData })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error('Backend error: ' + response.status + ' - ' + errorData.error);
                }

                const data = await response.json();
                const claudeResponse = data.evaluation;

                if (currentUser.userType === 'credits') {
                    currentUser.credits -= 1;
                    
                    if (currentUser.credits === 10 || currentUser.credits === 5) {
                        setTimeout(function() {
                            alert('You have ' + currentUser.credits + ' credits remaining. Consider purchasing more!');
                        }, 2000);
                    } else if (currentUser.credits === 0) {
                        setTimeout(function() {
                            alert('You\'re out of credits! Purchase more to continue using the evaluator.');
                        }, 2000);
                    }
                }

                const submission = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    userId: currentUser.id,
                    userEmail: currentUser.email,
                    formData: formData,
                    claudeResponse: claudeResponse
                };

                mockDB.submissions.push(submission);
                currentEvaluation = submission;
                
                const userIndex = mockDB.users.findIndex(function(u) { return u.id === currentUser.id; });
                if (userIndex !== -1) {
                    mockDB.users[userIndex] = currentUser;
                }

                saveToStorage();

                document.getElementById('originalLogline').textContent = '"' + formData.logline + '"';
                document.getElementById('evaluationResult').textContent = claudeResponse;
                
                showSection('results');
                updateUI();

            } catch (error) {
                console.error('Error evaluating logline:', error);
                alert('Sorry, there was an error evaluating your logline. Please try again.');
            } finally {
                button.disabled = false;
                text.textContent = 'Get My Evaluation';
                spinner.classList.add('hidden');
            }
        }

        function resetForm() {
            document.getElementById('genre').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('mainCharacter').value = '';
            document.getElementById('antagonist').value = '';
            document.getElementById('incitingIncident').value = '';
            document.getElementById('storyDetails').value = '';
            document.getElementById('logline').value = '';
            
            showSection('logline');
        }

  // Purchase Functions
function updatePurchaseSection() {
    const userSubmissions = mockDB.submissions.filter(function(s) { return s.userId === currentUser.id; }).length;
    const isBeta = currentUser.userType === 'credits' && userSubmissions === 0;
    
    if (isBeta) {
        document.getElementById('betaDiscount').classList.remove('hidden');
        document.getElementById('price25').textContent = '$15';
        document.getElementById('price50').textContent = '$28';
        document.getElementById('price100').textContent = '$50';
    } else {
        document.getElementById('betaDiscount').classList.add('hidden');
        document.getElementById('price25').textContent = '$30';
        document.getElementById('price50').textContent = '$55';
        document.getElementById('price100').textContent = '$100';
    }
}

async function purchaseCredits(amount) {
    const prices = { 25: 30, 50: 55, 100: 100 };
    const userSubmissions = mockDB.submissions.filter(function(s) { return s.userId === currentUser.id; }).length;
    const isBeta = currentUser.userType === 'credits' && userSubmissions === 0;
    const finalPrice = isBeta ? prices[amount] / 2 : prices[amount];

    try {
        const response = await fetch('/.netlify/functions/create-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: amount,
                price: finalPrice,
                userEmail: currentUser.email,
                userId: currentUser.id,
                isBeta: isBeta
            })
        });

        if (!response.ok) {
            throw new Error('Payment setup failed');
        }

        const session = await response.json();
        
        const result = await stripe.redirectToCheckout({
            sessionId: session.id
        });

        if (result.error) {
            alert('Payment failed: ' + (result.error.message || 'Unknown error'));
        }

    } catch (error) {
        console.error('Payment error:', error);
        alert('Payment failed. Please try again.');
    }
}

/*
    function handlePaymentSuccess(amount, sessionId) {
    const savedDB = localStorage.getItem('brs_db');
    if (savedDB) {
        mockDB = JSON.parse(savedDB);
    }
    
    const savedUser = localStorage.getItem('brs_user');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        
        currentUser.credits += parseInt(amount);
        
        const userIndex = mockDB.users.findIndex(function(u) { return u.id === currentUser.id; });
        if (userIndex !== -1) {
            mockDB.users[userIndex] = currentUser;
        }
        
        saveToStorage();
        
        alert('Payment successful! ' + amount + ' credits have been added to your account.');
        showApp();
    }
}
*/

        // Simplified placeholder functions
        function loadHistory() {
            document.getElementById('noHistory').classList.remove('hidden');
        }

        function toggleShowAllHistory() {
            // Placeholder
        }

        function downloadEvaluationPDF() {
            alert('PDF download feature will be implemented with jsPDF integration');
        }

        function updateEmail() {
            alert('Email updated successfully!');
        }

        function updatePassword() {
            alert('Password updated successfully!');
        }

        function managePayment() {
            alert('Payment management integration would go here (Stripe Customer Portal)');
        }

        function generateStudentCodes() {
            const quantity = parseInt(document.getElementById('codeQuantity').value) || 1;
            const months = parseInt(document.getElementById('codeMonths').value) || 3;

            const newCodes = [];
            for (let i = 0; i < quantity; i++) {
                const code = 'STUDENT-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                newCodes.push({
                    id: Date.now().toString() + i,
                    code: code,
                    months: months,
                    createdAt: new Date().toISOString(),
                    used: false
                });
            }

            mockDB.studentCodes.push.apply(mockDB.studentCodes, newCodes);
            saveToStorage();
            updateAdminSection();
            
            alert('Generated ' + quantity + ' codes for ' + months + ' months each!\n\nCodes: ' + newCodes.map(function(c) { return c.code; }).join(', '));
        }

        function downloadCodes() {
            alert('Codes download feature would generate CSV file');
        }

        function downloadAllSubmissions() {
            alert('Submissions download feature would generate CSV file');
        }

        function logout() {
    // Clear all admin sections before logging out
    document.getElementById('adminSettings').classList.add('hidden');
    document.getElementById('adminUserPayment').classList.add('hidden');
    
  localStorage.removeItem('brs_user');
    currentUser = null;
    currentView = 'login';
    currentEvaluation = null;
    
    document.getElementById('appSection').classList.add('hidden');
    document.getElementById('authSection').classList.remove('hidden');
    
    document.getElementById('authEmail').value = '';
    document.getElementById('authPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('studentCode').value = '';
    
    if (currentView !== 'login') {
        toggleAuthMode();
    }
}
}
    </script>
</body>
</html>
